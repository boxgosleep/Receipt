<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®±åº­å…¥å¤¢ - é«˜ç´šé›†é»å¡</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Cinzel:wght@700&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* === å…¨å±€é‡ç½® === */
        * { box-sizing: border-box; }
        body {
            font-family: 'Noto Serif TC', serif;
            background-color: #111; 
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px 0;
            margin: 0;
            color: #333;
            min-height: 100vh;
        }

        /* === æ§åˆ¶é¢æ¿ === */
        .controls {
            background: #222;
            padding: 10px 25px;
            border-radius: 50px;
            border: 1px solid #444;
            margin-bottom: 30px;
            display: flex;
            gap: 15px;
            align-items: center;
            color: #aaa;
            font-size: 13px;
        }
        select { 
            padding: 5px 10px; 
            border: 1px solid #555;
            background: #333;
            border-radius: 15px; 
            color: #eee;
            font-size: 13px;
            outline: none;
        }
        .btn-dl { 
            background: #ddd; 
            color: #111; 
            border: none; 
            padding: 6px 20px; 
            border-radius: 15px; 
            cursor: pointer; 
            font-weight: 700; 
            transition: 0.2s;
        }
        .btn-dl:hover { background: #fff; }

        /* === æˆªåœ–ç¯„åœ === */
        #capture-frame {
            background-color: #0a0a0a; 
            width: 700px;  
            min-height: 900px;
            padding: 60px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        /* === èˆå°å®¹å™¨ === */
        .stage-container {
            position: relative;
            width: 450px; 
            height: 720px; 
        }

        /* === å¡ç‰‡é€šç”¨ === */
        .card {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            border-radius: 2px;
            overflow: hidden;
        }

        /* === ç´™å¼µç´‹ç† (èƒŒæ™¯åœ–) === */
        .paper-bg {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #e8e6e1; /* ç±³ç°è‰²ç´™å¼µ */
            
            /* SVG å™ªé»ç´‹ç† */
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.15'/%3E%3C/svg%3E");
            
            /* ğŸ”¥ğŸ”¥ğŸ”¥ æ–°å¢é€™ä¸€è¡Œï¼é–å®šç´‹ç†å¤§å° ğŸ”¥ğŸ”¥ğŸ”¥ */
            /* æ•¸å€¼è¶Šå°ï¼Œç´‹ç†è¶Šç´°ç·»ã€‚200px æ˜¯å‰›å¥½é…åˆé€™å€‹ SVG çš„åŸå§‹è¨­å®š */
            background-size: 300px 300px; 

            z-index: 1;
        }

        /* === å…©å´è£é£¾å¡ç‰‡ === */
        .side-card {
            background: #888; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }
        .side-left {
            transform: translateX(-15px) translateY(10px); 
            z-index: 5;
            filter: brightness(0.6); 
        }
        .side-right {
            transform: translateX(15px) translateY(10px); 
            z-index: 5;
            filter: brightness(0.6); 
        }

        /* === ä¸­å¤®ä¸»å¡ç‰‡ === */
        .main-card {
            z-index: 10;
            box-shadow: 0 20px 60px rgba(0,0,0,0.6);
            display: flex;
            flex-direction: column;
            transform: translateY(0);
        }

        /* === å·¨å‹èƒŒæ™¯å­— === */
        .giant-text {
            position: absolute;
            top: -45px;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Cinzel', serif;
            font-size: 160px;
            color: #1a1a1a; 
            z-index: 2; 
            white-space: nowrap;
            letter-spacing: -5px;
            font-weight: 700;
            opacity: 0.1; 
        }

        /* === å‰æ™¯å…§å®¹å±¤ === */
        .content-layer {
            position: relative;
            z-index: 20; 
            padding: 40px 35px;
            flex: 1;
            display: flex;
            flex-direction: column;
            text-align: center;
        }

        .top-header { margin-bottom: 40px; color: #111; }
        .brand-name {
            font-family: 'Cinzel', serif;
            font-size: 10px;
            letter-spacing: 3px;
            color: #666;
            margin-bottom: 5px;
            display: block;
        }
        .card-title {
            font-family: 'Noto Serif TC', serif;
            font-size: 24px;
            font-weight: 700;
            color: #000; 
            letter-spacing: 2px;
        }

        .guest-row {
            font-family: 'Courier Prime', monospace;
            font-size: 11px;
            border-bottom: 1px solid #111;
            padding-bottom: 10px;
            margin-bottom: 40px;
            text-align: center;
            color: #000;
            letter-spacing: 1px;
        }
        .guest-row span { font-weight: 520; }

        /* === åˆ—è¡¨å€åŸŸ === */
        .list-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .row {
            display: flex;
            align-items: center; 
            justify-content: space-between;
            font-size: 12px;
            color: #111;
            width: 100%;
        }
        
        .date {
            font-family: 'Courier Prime', monospace;
            font-weight: 700;
            width: 45px; 
            text-align: left;
            flex-shrink: 0;
        }
        
        .dots {
            flex: 1; 
            border-bottom: 1px dotted #999;
            margin: 0 8px;
            height: 5px; 
            opacity: 0.5;
        }
        
        .desc {
            font-weight: 500;
            white-space: nowrap; 
            color: #222;
        }
        .desc-use { color: #000; font-weight: 700; }
        
        .points {
            font-family: 'Courier Prime', monospace;
            font-weight: 700;
            width: 25px; 
            text-align: right;
            flex-shrink: 0;
        }
        .p-plus { color: #111; }
        .p-minus { color: #555; } 

        /* åº•éƒ¨ */
        .footer {
            margin-top: auto;
            padding-top: 30px;
            border-top: 2px solid #000;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }
        
        .footer-info {
            text-align: left;
            font-size: 9px;
            line-height: 1.6;
            color: #444;
            font-family: 'Courier Prime', monospace;
        }

        .total-box { text-align: right; }
        .lbl { 
            /* ğŸ”¥ æ–°å¢é€™ä¸€è¡Œï¼šå¾€ä¸Šæ¨ 15px (æ•¸å­—è¶Šå¤§è¶Šé«˜) */
            padding-bottom: 7px;
            font-size: 9px; 
            text-transform: uppercase; 
            letter-spacing: 1px; 
            color: #666;
        }
        .big-num {
            font-family: 'Cinzel', serif;
            font-size: 50px;
            line-height: 1;
            color: #000;
            font-weight: 700;
        }

    </style>
</head>
<body>

    <div class="controls">
        <span>â˜ï¸ é›†é»ç³»çµ±</span>
        <select id="userSelect" onchange="generateReceipt()">
            <option value="">-- è«‹é¸æ“‡ ID --</option>
        </select>
        <button class="btn-dl" onclick="downloadImage()">ä¸‹è¼‰é›†é»å¡</button>
        <span id="statusMsg" style="font-size:11px; color:#666;">åˆå§‹åŒ–...</span>
    </div>

    <div id="capture-frame">
        <div class="stage-container">
            
            <div class="card side-card side-left">
                <div class="paper-bg"></div>
            </div>

            <div class="card side-card side-right">
                <div class="paper-bg"></div>
            </div>

            <div class="card main-card">
                <div class="paper-bg"></div>
                <div class="giant-text">HAKONIWA</div>

                <div class="content-layer">
                    <div class="top-header">
                        <span class="brand-name">HAKONIWA IRUME</span>
                        <span class="card-title">é›†é»å¡</span>
                    </div>

                    <div class="guest-row">
                        GUEST NO. <span id="displayUser">---</span>
                    </div>

                    <div class="list-area" id="recordList">
                        <div style="color:#aaa; margin-top:100px; font-size:11px;">
                            WAITING FOR DATA...
                        </div>
                    </div>

                    <div class="footer">
                        <div class="footer-info">
                            OFFICIAL EVENT<br>
                            <span id="issuePrefix">ISSUE</span> <span id="autoDate">....</span>
                        </div>
                        <div class="total-box">
                            <div class="lbl">Total Points</div>
                            <div class="big-num" id="totalPoints">0</div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSRN8TqorraKVjJ3FGYpndM6aUQFQcor-4TzrIG_smGY42hTgteuLL_lvGNMKj1wcYPQ70WMz-iWMpA/pub?output=csv'; 

        let globalData = [];

        window.onload = function() {
            // ğŸ”¥ 1. åˆå§‹åŒ–æ™‚è‡ªå‹•å¡«å…¥ç•¶å‰æœˆä»½
            updateCurrentDate();

            if(CSV_URL.includes('pubhtml')) {
                document.getElementById('statusMsg').innerText = "âŒ é€£çµéŒ¯èª¤";
                return;
            }
            fetchAndInit();
        };

        // ğŸ”¥ è‡ªå‹•æŠ“å–æ—¥æœŸçš„å‡½å¼
        function updateCurrentDate() {
            const now = new Date();
            const year = now.getFullYear();
            // æœˆä»½è¨˜å¾— +1ï¼Œä¸¦ä¸”è£œé›¶ (ä¾‹å¦‚ 2 -> 02)
            const month = String(now.getMonth() + 1).padStart(2, '0');
            
            // å¡«å…¥ HTML
            document.getElementById('autoDate').innerText = `${year}-${month}`;
        }

        function fetchAndInit() {
            document.getElementById('statusMsg').innerText = "è®€å–ä¸­...";
            Papa.parse(CSV_URL, {
                download: true, header: true, skipEmptyLines: true,
                complete: function(results) {
                    if (results.data && results.data.length > 0) {
                        globalData = results.data;
                        initDropdown();
                        document.getElementById('statusMsg').innerText = "âœ… å°±ç·’";
                    }
                }
            });
        }

        function initDropdown() {
            const select = document.getElementById('userSelect');
            select.innerHTML = '<option value="">-- è«‹é¸æ“‡ ID --</option>';
            let idKey = Object.keys(globalData[0]).find(k => k.toUpperCase().includes('ID')) || Object.keys(globalData[0])[0];
            globalData.forEach(row => {
                let val = row[idKey]; 
                if (val && val.trim() !== '') {
                    let option = document.createElement('option');
                    option.value = val; option.text = val; select.appendChild(option);
                }
            });
        }

        function generateReceipt() {
            const userId = document.getElementById('userSelect').value;
            const listContainer = document.getElementById('recordList');
            
            if (!userId) {
                document.getElementById('displayUser').innerText = "---";
                document.getElementById('totalPoints').innerText = "0";
                listContainer.innerHTML = '<div style="color:#aaa; margin-top:100px;">WAITING...</div>';
                return;
            }

            document.getElementById('displayUser').innerText = userId;
            listContainer.innerHTML = ''; 

            let idKey = Object.keys(globalData[0]).find(k => k.toUpperCase().includes('ID')) || Object.keys(globalData[0])[0];
            const userRow = globalData.find(row => row[idKey] == userId);

           if (userRow) {
                let pointKey = Object.keys(userRow).find(k => k.includes('é»æ•¸')) || 'ç›®å‰é»æ•¸';
                document.getElementById('totalPoints').innerText = userRow[pointKey] || "0";

                let allHistoryKeys = Object.keys(userRow).filter(k => k.includes('æ­·å²') || k.includes('ç´€éŒ„'));
                let rawHistory = allHistoryKeys.length > 0 ? allHistoryKeys.map(key => userRow[key]).join("\n") : (userRow['æ¶ˆè²»æ­·å²'] || "");
                
                const rawLines = rawHistory.split(/[\n\r]+/); 
                let records = [];

               rawLines.forEach(line => {
                    let cleanLine = line.trim().replace(/^-\s*/, '');
                    if (cleanLine.length < 5) return;
                    let dateStr = "??.??"; let rawDateVal = "0"; let desc = cleanLine;
                    let type = 'earn'; let points = '';
                    let matchFormat1 = cleanLine.match(/^(\d{6})/);
                    let matchFormat2 = cleanLine.match(/^(\d{4}-\d{2}-\d{2})/);

                    if (matchFormat1) {
                        let d = matchFormat1[1];
                        dateStr = `${d.substr(2,2)}.${d.substr(4,2)}`; 
                        rawDateVal = d;
                        desc = cleanLine.substring(6);
                    } else if (matchFormat2) {
                        let d = matchFormat2[1]; 
                        dateStr = d.replace(/-/g, '.').substr(5); 
                        rawDateVal = d.replace(/-/g, '');
                        desc = cleanLine.substring(10);
                    }

                    if (desc.includes('å…Œæ›') || desc.includes('ä½¿ç”¨')) {
                        type = 'use';
                        let ptMatch = desc.match(/ä½¿ç”¨(\d+)é»/); 
                        if (ptMatch) points = "-" + ptMatch[1];
                        desc = desc.replace(/ä½¿ç”¨\d+é»/, "").replace(/å…Œæ›/, "").trim(); 
                    } else {
                        type = 'earn';
                        let ptMatch = desc.match(/ç²å¾—(\d+)é»/);
                        if (ptMatch) points = " " + ptMatch[1];
                        if(desc.includes('æ¶ˆè²»')) {
                            let moneyMatch = desc.match(/(\d+)å…ƒ/);
                            if(moneyMatch) desc = `æ¶ˆè²» ${moneyMatch[1]}å…ƒ`; 
                            else desc = "æ¶ˆè²»ç´¯ç©";
                        }
                    }
                    records.push({ date: dateStr, desc: desc, points: points, type: type, rawSort: rawDateVal });
                });

                records.sort((a, b) => b.rawSort.localeCompare(a.rawSort));
                
                if (records.length > 12) records = records.slice(0, 12); 

                if (records.length === 0) {
                     listContainer.innerHTML = `<div style="margin-top:50px; color:#aaa; text-align:center;">NO RECORDS</div>`;
                } else {
                    records.forEach(rec => {
                        let div = document.createElement('div');
                        div.className = 'row';
                        
                        let ptClass = rec.type === 'earn' ? 'p-plus' : 'p-minus';
                        if(rec.type==='none') ptClass = '';
                        let descClass = rec.type === 'use' ? 'desc desc-use' : 'desc';

                        div.innerHTML = `
                            <div class="date">${rec.date}</div>
                            <div class="dots"></div>
                            <div class="${descClass}">${rec.desc}</div>
                            <div class="dots"></div>
                            <div class="points ${ptClass}">${rec.points}</div>
                        `;
                        listContainer.appendChild(div);
                    });
                }
            }
        }

        function downloadImage() {
            const node = document.getElementById('capture-frame');
            const btn = document.querySelector('.btn-dl');
            const userName = document.getElementById('displayUser').innerText;
            if (userName === "---" || userName === "") { alert("è«‹å…ˆé¸æ“‡å®¢äººï¼"); return; }
            
            const originalText = btn.innerText;
            btn.innerText = "è£½ä½œä¸­..."; 
            btn.disabled = true; 
            window.scrollTo(0,0);
            
            html2canvas(node, { 
                scale: 2, 
                useCORS: true, 
                allowTaint: true, 
                backgroundColor: "#0a0a0a" 
            }).then(canvas => {
                let link = document.createElement('a');
                link.download = `ç®±åº­é›†é»å¡_${userName}.jpg`;
                link.href = canvas.toDataURL("image/jpeg", 0.95);
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
                btn.innerText = originalText; btn.disabled = false;
            }).catch(err => { 
                console.error(err); 
                alert("ä¸‹è¼‰å¤±æ•—"); 
                btn.innerText = originalText; 
                btn.disabled = false; 
            });
        }
    </script>
</body>
</html>
