<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>箱庭入夢 - 集點手帳</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        /* === 基礎設定 === */
        body {
            font-family: 'Noto Serif TC', serif;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px;
            color: #555;
            margin: 0;
        }

        /* === 控制面板 === */
        .controls {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            text-align: center;
            width: 100%;
            max-width: 400px;
            border: 1px solid #eef;
        }
        .controls h3 { margin-top: 0; color: #8faecf; }
        input {
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            width: 70%;
            text-align: center;
            font-family: inherit;
            margin-bottom: 10px;
        }
        button {
            padding: 10px 25px;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-family: inherit;
            transition: 0.3s;
            font-weight: bold;
            letter-spacing: 1px;
        }
        .btn-gen { background: #a1c4fd; color: white; }
        .btn-dl { background: #fad0c4; color: white; margin-left: 10px; }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }

        /* === 收據卡片設計 (核心設計區) === */
        #receipt-canvas {
            width: 500px; 
            min-height: 700px;
            background: #fff;
            position: relative;
            box-shadow: 0 15px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            /* 模擬紙張紋理 */
            background-image: repeating-linear-gradient(45deg, #fffcfc 25%, transparent 25%, transparent 75%, #fffcfc 75%, #fffcfc), repeating-linear-gradient(45deg, #fffcfc 25%, #fff 25%, #fff 75%, #fffcfc 75%, #fffcfc);
            background-position: 0 0, 10px 10px;
            background-size: 20px 20px;
        }

        /* 裝飾：夢幻漸層光暈 (參考圖的粉/藍氛圍) */
        .gradient-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(60px);
            z-index: 0;
        }
        .orb-1 { top: -50px; right: -50px; width: 300px; height: 300px; background: rgba(161, 196, 253, 0.4); } /* 淺藍 */
        .orb-2 { bottom: -50px; left: -50px; width: 350px; height: 350px; background: rgba(250, 208, 196, 0.4); } /* 淺粉 */

        /* 內容佈局 */
        .layout-container {
            position: relative;
            z-index: 2;
            width: 100%;
            display: flex;
            padding: 40px;
        }

        /* 左側：直排標題 (模擬書脊) */
        .sidebar {
            width: 70px;
            border-right: 1px solid rgba(0,0,0,0.05);
            margin-right: 30px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            align-items: center;
            padding-top: 20px;
            padding-bottom: 20px;
        }
        .vertical-text {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            letter-spacing: 0.8em;
            color: #8faecf; /* 主題藍色 */
            font-size: 24px;
            font-weight: 300;
        }
        .logo-text {
            writing-mode: vertical-rl;
            font-size: 10px;
            letter-spacing: 2px;
            color: #ccc;
            text-transform: uppercase;
        }

        /* 右側：主要內容區 */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .header-info {
            text-align: right;
            margin-bottom: 30px;
            border-bottom: 2px solid #fad0c4; /* 粉色裝飾線 */
            padding-bottom: 15px;
        }
        .user-id {
            font-size: 14px;
            color: #aaa;
            letter-spacing: 1px;
        }
        .user-name {
            font-size: 22px;
            color: #555;
            margin-top: 5px;
            font-weight: 500;
        }

        /* 列表樣式 */
        .record-list {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1;
        }
        .record-item {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 12px;
            font-size: 13px;
            border-bottom: 1px dashed #eee;
            padding-bottom: 8px;
        }
        .item-date {
            font-family: 'Courier New', monospace; /* 日期用等寬字體比較整齊 */
            color: #bbb;
            margin-right: 10px;
            font-size: 12px;
        }
        .item-desc { color: #666; flex: 1; }
        .item-points { font-weight: bold; margin-left: 10px; }
        .p-earn { color: #8faecf; } /* 獲得點數顏色 */
        .p-use { color: #fab1a0; }  /* 使用點數顏色 */

        /* 底部總結 */
        .footer-summary {
            margin-top: 30px;
            text-align: right;
            position: relative;
        }
        .total-label {
            font-size: 11px;
            color: #ccc;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        .total-points {
            font-size: 48px;
            color: #8faecf;
            line-height: 1;
            font-weight: 300;
            margin-top: 5px;
        }
        .total-unit { font-size: 16px; margin-left: 5px; }

        /* 裝飾性的小幾何圖形 */
        .deco-star {
            position: absolute;
            color: #fad0c4;
            font-size: 20px;
            opacity: 0.6;
        }
    </style>
</head>
<body>

    <div class="controls">
        <h3>☁️ 箱庭入夢・集點櫃台</h3>
        <input type="text" id="userIdInput" placeholder="請輸入噗浪 ID (例如: namida127_draw)">
        <br>
        <button class="btn-gen" onclick="generateReceipt()">生成手帳</button>
        <button class="btn-dl" onclick="downloadImage()">下載圖片</button>
        <p id="statusMsg" style="font-size:12px; color:#aaa; margin-top:10px;">系統準備就緒</p>
    </div>

    <div id="receipt-canvas">
        <div class="gradient-orb orb-1"></div>
        <div class="gradient-orb orb-2"></div>
        <div class="deco-star" style="top:40px; left:120px;">✦</div>
        <div class="deco-star" style="bottom:80px; left:60px;">✦</div>
        <div class="deco-star" style="top:150px; right:40px;">*</div>

        <div class="layout-container">
            <div class="sidebar">
                <div class="vertical-text">深秋入冬</div>
                <div class="logo-text">Hakoniwa Irume</div>
                <div class="vertical-text" style="font-size: 14px; margin-top: auto;">集點手帳</div>
            </div>

            <div class="main-content">
                <div class="header-info">
                    <div class="user-id">PLURK ID</div>
                    <div class="user-name">@<span id="displayUser">---</span></div>
                </div>

                <ul class="record-list" id="recordList">
                    <li style="text-align:center; color:#ddd; margin-top:50px;">等待輸入 ID...</li>
                </ul>

                <div class="footer-summary">
                    <div class="total-label">Current Points</div>
                    <div class="total-points"><span id="totalPoints">0</span><span class="total-unit">pts</span></div>
                    <div style="font-size: 10px; color: #ddd; margin-top: 10px;">
                        具體兌換規則請至置頂噗 (回饋福利)
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // === 資料來源設定 (你提供的連結) ===
        const URL_CONSUME = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSRN8TqorraKVjJ3FGYpndM6aUQFQcor-4TzrIG_smGY42hTgteuLL_lvGNMKj1wcYPQ70WMz-iWMpA/pub?gid=1022565365&single=true&output=csv';
        const URL_REDEEM = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSRN8TqorraKVjJ3FGYpndM6aUQFQcor-4TzrIG_smGY42hTgteuLL_lvGNMKj1wcYPQ70WMz-iWMpA/pub?gid=1106654600&single=true&output=csv';

        let consumeData = [];
        let redeemData = [];
        let isDataLoaded = false;

        // 頁面載入時自動抓取資料
        window.onload = function() {
            updateStatus("正在讀取箱庭紀錄...");
            Promise.all([
                fetchData(URL_CONSUME),
                fetchData(URL_REDEEM)
            ]).then(results => {
                consumeData = results[0];
                redeemData = results[1];
                isDataLoaded = true;
                updateStatus("資料載入完成，請輸入 ID");
                console.log("消費紀錄:", consumeData);
                console.log("兌換紀錄:", redeemData);
            }).catch(err => {
                updateStatus("資料讀取失敗，請檢查網路");
                console.error(err);
            });
        };

        function fetchData(url) {
            return new Promise((resolve, reject) => {
                Papa.parse(url, {
                    download: true,
                    header: false, // 不使用標題模式，直接用 index 抓比較穩
                    complete: function(results) {
                        resolve(results.data);
                    },
                    error: function(err) {
                        reject(err);
                    }
                });
            });
        }

        function updateStatus(msg) {
            document.getElementById('statusMsg').innerText = msg;
        }

        function generateReceipt() {
            if (!isDataLoaded) { alert("資料還在讀取中，請稍等..."); return; }
            
            const userId = document.getElementById('userIdInput').value.trim();
            if (!userId) { alert("請輸入 ID！"); return; }

            document.getElementById('displayUser').innerText = userId;
            const listContainer = document.getElementById('recordList');
            listContainer.innerHTML = '';

            let totalPoints = 0;
            let allRecords = [];

            // === 1. 處理消費紀錄 (根據你的截圖推測結構) ===
            // 假設欄位順序: Col A (0)=ID, Col B (1)=日期, Col C (2)=金額
            consumeData.forEach((row, index) => {
                if (index === 0) return; // 跳過標題列
                if (!row[0]) return;     // 跳過空行

                // 模糊比對 ID (忽略大小寫與空白)
                if (row[0].trim().toLowerCase() === userId.toLowerCase()) {
                    let amount = parseInt(row[2]); // 金額
                    if (!isNaN(amount)) {
                        let pts = Math.floor(amount / 800); // 你的公式: 800元一點
                        totalPoints += pts;
                        allRecords.push({
                            type: 'earn',
                            date: formatSheetDate(row[1]),
                            text: `累積消費 ${amount} 元`,
                            points: pts
                        });
                    }
                }
            });

            // === 2. 處理兌換紀錄 ===
            // 假設欄位順序: Col A (0)=ID, Col B (1)=日期, Col C (2)=項目, Col D (3)=使用點數
            redeemData.forEach((row, index) => {
                if (index === 0) return; 
                if (!row[0]) return;

                if (row[0].trim().toLowerCase() === userId.toLowerCase()) {
                    let cost = parseInt(row[3]); // 點數
                    if (!isNaN(cost)) {
                        totalPoints -= cost;
                        allRecords.push({
                            type: 'use',
                            date: formatSheetDate(row[1]),
                            text: `兌換 ${row[2]}`,
                            points: cost
                        });
                    }
                }
            });

            // === 3. 排序 (日期新 -> 舊) ===
            allRecords.sort((a, b) => b.date.localeCompare(a.date));

            // === 4. 渲染到畫面 ===
            if (allRecords.length === 0) {
                listContainer.innerHTML = '<li style="text-align:center; color:#ddd; margin-top:50px;">查無此 ID 的紀錄</li>';
            } else {
                allRecords.forEach(rec => {
                    // 根據是獲得還是使用，顯示不同顏色
                    let pointClass = rec.type === 'earn' ? 'p-earn' : 'p-use';
                    let sign = rec.type === 'earn' ? '+' : '-';
                    
                    let li = document.createElement('li');
                    li.className = 'record-item';
                    li.innerHTML = `
                        <span class="item-date">${rec.date}</span>
                        <span class="item-desc">${rec.text}</span>
                        <span class="item-points ${pointClass}">${sign}${rec.points}</span>
                    `;
                    listContainer.appendChild(li);
                });
            }

            // 更新總分
            document.getElementById('totalPoints').innerText = totalPoints;
        }

        // 日期格式化工具 (YYYY/MM/DD -> YY.MM.DD)
        function formatSheetDate(dateStr) {
            if (!dateStr) return "";
            // 簡單處理：如果是 YYYY/MM/DD 或 YYYY-MM-DD
            let cleanDate = dateStr.replace(/-/g, '/');
            let dateObj = new Date(cleanDate);
            
            if (isNaN(dateObj.getTime())) return dateStr; // 無法解析就回傳原字串

            let yy = dateObj.getFullYear().toString().substr(-2);
            let mm = (dateObj.getMonth() + 1).toString().padStart(2, '0');
            let dd = dateObj.getDate().toString().padStart(2, '0');
            return `${yy}.${mm}.${dd}`;
        }

        // 下載圖片
        function downloadImage() {
            const node = document.getElementById('receipt-canvas');
            // scale: 2 可以讓圖片解析度變高 (Retina等級)
            html2canvas(node, { scale: 2, backgroundColor: null }).then(canvas => {
                let link = document.createElement('a');
                link.download = `箱庭手帳_${document.getElementById('displayUser').innerText}.jpg`;
                link.href = canvas.toDataURL("image/jpeg", 0.9);
                link.click();
            });
        }
    </script>
</body>
</html>
