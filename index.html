<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®±åº­å…¥å¤¢ - é«˜ç´šé›†é»å¡</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Cinzel:wght@700&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* === å…¨å±€é‡ç½® === */
        * { box-sizing: border-box; }
        body {
            font-family: 'Noto Serif TC', serif;
            background-color: #111; 
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            margin: 0;
            color: #333;
            min-height: 100vh;
            /* é˜²æ­¢æ‰‹æ©Ÿå·¦å³æ»‘å‹• */
            overflow-x: hidden; 
        }

        /* === âœ¨ UI å„ªåŒ–ï¼šæ‰‹æ©Ÿå‹å–„æ§åˆ¶é¢æ¿ === */
        .controls {
            background: rgba(30, 30, 30, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px 25px;
            border-radius: 20px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            align-items: center;
            color: #aaa;
            font-size: 14px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            width: 90%;
            max-width: 600px;
            position: sticky;
            top: 20px;
            z-index: 100;
        }

        select { 
            padding: 10px 15px; 
            border: 1px solid #555;
            background: #222;
            border-radius: 10px; 
            color: #fff;
            font-size: 14px;
            outline: none;
            cursor: pointer;
            flex: 1;
            min-width: 150px;
        }

        .btn-dl { 
            background: #e0e0e0; 
            color: #111; 
            border: none; 
            padding: 10px 25px; 
            border-radius: 10px; 
            cursor: pointer; 
            font-weight: 700; 
            transition: 0.2s;
            font-size: 14px;
            white-space: nowrap;
            box-shadow: 0 4px 10px rgba(255,255,255,0.1);
        }
        .btn-dl:hover { background: #fff; transform: translateY(-2px); }
        .btn-dl:disabled { opacity: 0.6; cursor: not-allowed; }

        @media (max-width: 500px) {
            .controls { flex-direction: column; gap: 10px; }
            select, .btn-dl { width: 100%; text-align: center; }
        }

        /* === æˆªåœ–ç¯„åœ (èšå…‰ç‡ˆèƒŒæ™¯) === */
        #capture-frame {
            background: radial-gradient(circle at center, #333333 0%, #000000 80%);
            
            /* ğŸ”¥ğŸ”¥ğŸ”¥ ä¿®æ”¹é» 1ï¼šå¼·åˆ¶å›ºå®šå¯¬åº¦ï¼Œä¸è®“ CSS éŸ¿æ‡‰å¼æ”¹è®Šå®ƒ ğŸ”¥ğŸ”¥ğŸ”¥ */
            width: 700px !important;  
            min-width: 700px;
            
            min-height: 900px;
            padding: 60px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            
            /* è¨­å®šè®Šå½¢åŸé»åœ¨ä¸Šæ–¹ï¼Œæ–¹ä¾¿ JS ç¸®æ”¾æ™‚å°é½Š */
            transform-origin: top center;
            flex-shrink: 0; 
        }
        
        /* ğŸ”¥ğŸ”¥ğŸ”¥ ä¿®æ”¹é» 2ï¼šåˆªé™¤äº†åŸæœ¬é€™è£¡çš„ @media zoom è¨­å®šï¼Œæ”¹ç”¨ JS æ§åˆ¶ ğŸ”¥ğŸ”¥ğŸ”¥ */

        /* === èˆå°å®¹å™¨ === */
        .stage-container {
            position: relative;
            width: 450px; 
            height: 720px; 
        }

        /* === å¡ç‰‡é€šç”¨ === */
        .card {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            border-radius: 2px;
            overflow: hidden;
        }

        /* === ç´™å¼µç´‹ç† === */
        .paper-bg {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #e8e6e1; 
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.15'/%3E%3C/svg%3E");
            background-size: 300px 300px; 
            z-index: 1;
        }

        /* === å…©å´è£é£¾å¡ç‰‡ === */
        .side-card {
            background: #888; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }
        .side-left {
            transform: translateX(-15px) translateY(10px); 
            z-index: 5;
            filter: brightness(0.6); 
        }
        .side-right {
            transform: translateX(15px) translateY(10px); 
            z-index: 5;
            filter: brightness(0.6); 
        }

        /* === ä¸­å¤®ä¸»å¡ç‰‡ === */
        .main-card {
            z-index: 10;
            box-shadow: 0 30px 80px rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            transform: translateY(0);
        }

        /* === å·¨å‹èƒŒæ™¯å­— === */
        .giant-text {
            position: absolute;
            top: -45px;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Cinzel', serif;
            font-size: 160px;
            color: #1a1a1a; 
            z-index: 2; 
            white-space: nowrap;
            letter-spacing: -5px;
            font-weight: 700;
            opacity: 0.1; 
        }

        /* === å‰æ™¯å…§å®¹å±¤ === */
        .content-layer {
            position: relative;
            z-index: 20; 
            padding: 40px 35px;
            flex: 1;
            display: flex;
            flex-direction: column;
            text-align: center;
        }

        .top-header { margin-bottom: 40px; color: #111; }
        .brand-name {
            font-family: 'Cinzel', serif;
            font-size: 10px;
            letter-spacing: 3px;
            color: #666;
            margin-bottom: 5px;
            display: block;
        }
        .card-title {
            font-family: 'Noto Serif TC', serif;
            font-size: 24px;
            font-weight: 700;
            color: #000; 
            letter-spacing: 2px;
        }

        .guest-row {
            font-family: 'Courier Prime', monospace;
            font-size: 11px;
            border-bottom: 1px solid #111;
            padding-bottom: 10px;
            margin-bottom: 40px;
            text-align: center;
            color: #000;
            letter-spacing: 1px;
        }
        .guest-row span { font-weight: 520; }

        .list-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .row {
            display: flex;
            align-items: center; 
            justify-content: space-between;
            font-size: 12px;
            color: #111;
            width: 100%;
        }
        
        .date {
            font-family: 'Courier Prime', monospace;
            font-weight: 700;
            width: 45px; 
            text-align: left;
            flex-shrink: 0;
        }
        
        .dots {
            flex: 1; 
            border-bottom: 1px dotted #999;
            margin: 0 8px;
            height: 5px; 
            opacity: 0.5;
        }
        
        .desc {
            font-weight: 500;
            white-space: nowrap; 
            color: #222;
        }
        .desc-use { color: #000; font-weight: 700; }
        
        .points {
            font-family: 'Courier Prime', monospace;
            font-weight: 700;
            width: 25px; 
            text-align: right;
            flex-shrink: 0;
        }
        .p-plus { color: #111; }
        .p-minus { color: #555; } 

        .footer {
            margin-top: auto;
            padding-top: 30px;
            border-top: 2px solid #000;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }
        
        .footer-info {
            text-align: left;
            font-size: 9px;
            line-height: 1.6;
            color: #444;
            font-family: 'Courier Prime', monospace;
        }

        .total-box { text-align: right; }
        .lbl {
            padding-bottom: 9px; 
            font-size: 9px; 
            text-transform: uppercase; 
            letter-spacing: 1.5px; 
            color: #666;
        }
        .big-num {
            font-family: 'Cinzel', serif;
            font-size: 50px;
            line-height: 1;
            color: #000;
            font-weight: 700;
        }

    </style>
</head>
<body>

    <div class="controls">
        <span style="font-weight:bold;">â˜ï¸ HAKONIWA</span>
        <select id="userSelect" onchange="generateReceipt()">
            <option value="">-- è«‹é¸æ“‡ ID --</option>
        </select>
        <button class="btn-dl" onclick="downloadImage()">ä¸‹è¼‰é›†é»å¡</button>
        <div id="statusMsg" style="width:100%; text-align:center; font-size:11px; margin-top:5px; display:none;">åˆå§‹åŒ–...</div>
    </div>

    <div id="capture-frame">
        <div class="stage-container">
            <div class="card side-card side-left">
                <div class="paper-bg"></div>
            </div>
            <div class="card side-card side-right">
                <div class="paper-bg"></div>
            </div>
            <div class="card main-card">
                <div class="paper-bg"></div>
                <div class="giant-text">HAKONIWA</div>
                <div class="content-layer">
                    <div class="top-header">
                        <span class="brand-name">HAKONIWA IRUME</span>
                        <span class="card-title">é›†é»å¡</span>
                    </div>
                    <div class="guest-row">
                        GUEST NO. <span id="displayUser">---</span>
                    </div>
                    <div class="list-area" id="recordList">
                        <div style="color:#aaa; margin-top:100px; font-size:11px;">
                            WAITING FOR DATA...
                        </div>
                    </div>
                    <div class="footer">
                        <div class="footer-info">
                            OFFICIAL EVENT<br>
                            <span id="issuePrefix">ISSUE</span> <span id="autoDate">....</span>
                        </div>
                        <div class="total-box">
                            <div class="lbl">Total Points</div>
                            <div class="big-num" id="totalPoints">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSRN8TqorraKVjJ3FGYpndM6aUQFQcor-4TzrIG_smGY42hTgteuLL_lvGNMKj1wcYPQ70WMz-iWMpA/pub?output=csv'; 

        let globalData = [];

        window.onload = function() {
            updateCurrentDate();
            
            // ğŸ”¥ğŸ”¥ğŸ”¥ ä¿®æ”¹é» 3ï¼šåˆå§‹åŒ–æ™‚åŸ·è¡Œä¸€æ¬¡è¦–è¦ºç¸®æ”¾é è¦½ï¼Œä¸¦ç›£è½è¦–çª—è®ŠåŒ– ğŸ”¥ğŸ”¥ğŸ”¥
            autoScalePreview();
            window.addEventListener('resize', autoScalePreview);

            const msg = document.getElementById('statusMsg');
            msg.style.display = 'block';
            msg.innerText = "è®€å–è³‡æ–™ä¸­...";

            if(CSV_URL.includes('pubhtml')) {
                msg.innerText = "âŒ é€£çµéŒ¯èª¤";
                return;
            }
            fetchAndInit();
        };

        // ğŸ”¥ğŸ”¥ğŸ”¥ ä¿®æ”¹é» 4ï¼šæ–°å¢è‡ªå‹•ç¸®æ”¾å‡½æ•¸ (åªç¸®æ”¾è¦–è¦ºï¼Œä¸æ”¹è®Šå¯¦éš›æ’ç‰ˆ) ğŸ”¥ğŸ”¥ğŸ”¥
        function autoScalePreview() {
            const frame = document.getElementById('capture-frame');
            const screenWidth = window.innerWidth;
            const targetWidth = 720; // ç†æƒ³çš„å¡ç‰‡å®¹å™¨å¯¬åº¦ (æ¯” 700 ç¨å¤§ä¸€é»)

            if (screenWidth < targetWidth) {
                // è¨ˆç®—ç¸®æ”¾æ¯”ä¾‹
                const scale = screenWidth / targetWidth;
                // å¥—ç”¨ç¸®æ”¾
                frame.style.transform = `scale(${scale})`;
                // å› ç‚º scale æ˜¯ç¸®æ”¾é¡¯ç¤ºï¼Œä¸‹æ–¹æœƒç•™ç™½ï¼Œæ‰€ä»¥è¦æŠŠä¸‹æ–¹ margin æ‹‰å›ä¾†
                // è¨ˆç®—å…¬å¼å¤§è‡´ç‚ºï¼šåŸå§‹é«˜åº¦ * (1 - æ¯”ä¾‹)
                frame.style.marginBottom = `-${(1 - scale) * 900}px`; 
            } else {
                frame.style.transform = 'none';
                frame.style.marginBottom = '0px';
            }
        }

        function updateCurrentDate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            document.getElementById('autoDate').innerText = `${year}-${month}`;
        }

        function fetchAndInit() {
            Papa.parse(CSV_URL, {
                download: true, header: true, skipEmptyLines: true,
                complete: function(results) {
                    if (results.data && results.data.length > 0) {
                        globalData = results.data;
                        initDropdown();
                        document.getElementById('statusMsg').innerText = "âœ… è³‡æ–™å°±ç·’";
                        setTimeout(() => { document.getElementById('statusMsg').style.display = 'none'; }, 2000);
                    }
                }
            });
        }

        function initDropdown() {
            const select = document.getElementById('userSelect');
            select.innerHTML = '<option value="">-- è«‹é¸æ“‡ ID --</option>';
            let idKey = Object.keys(globalData[0]).find(k => k.toUpperCase().includes('ID')) || Object.keys(globalData[0])[0];
            globalData.forEach(row => {
                let val = row[idKey]; 
                if (val && val.trim() !== '') {
                    let option = document.createElement('option');
                    option.value = val; option.text = val; select.appendChild(option);
                }
            });
        }

        function generateReceipt() {
            const userId = document.getElementById('userSelect').value;
            const listContainer = document.getElementById('recordList');
            
            if (!userId) {
                document.getElementById('displayUser').innerText = "---";
                document.getElementById('totalPoints').innerText = "0";
                listContainer.innerHTML = '<div style="color:#aaa; margin-top:100px;">WAITING...</div>';
                return;
            }

            document.getElementById('displayUser').innerText = userId;
            listContainer.innerHTML = ''; 

            let idKey = Object.keys(globalData[0]).find(k => k.toUpperCase().includes('ID')) || Object.keys(globalData[0])[0];
            const userRow = globalData.find(row => row[idKey] == userId);

           if (userRow) {
                let pointKey = Object.keys(userRow).find(k => k.includes('é»æ•¸')) || 'ç›®å‰é»æ•¸';
                document.getElementById('totalPoints').innerText = userRow[pointKey] || "0";

                let allHistoryKeys = Object.keys(userRow).filter(k => k.includes('æ­·å²') || k.includes('ç´€éŒ„'));
                let rawHistory = allHistoryKeys.length > 0 ? allHistoryKeys.map(key => userRow[key]).join("\n") : (userRow['æ¶ˆè²»æ­·å²'] || "");
                
                const rawLines = rawHistory.split(/[\n\r]+/); 
                let records = [];

               rawLines.forEach(line => {
                    let cleanLine = line.trim().replace(/^-\s*/, '');
                    if (cleanLine.length < 5) return;
                    let dateStr = "??.??"; let rawDateVal = "0"; let desc = cleanLine;
                    let type = 'earn'; let points = '';
                    let matchFormat1 = cleanLine.match(/^(\d{6})/);
                    let matchFormat2 = cleanLine.match(/^(\d{4}-\d{2}-\d{2})/);

                    if (matchFormat1) {
                        let d = matchFormat1[1];
                        dateStr = `${d.substr(2,2)}.${d.substr(4,2)}`; 
                        rawDateVal = d;
                        desc = cleanLine.substring(6);
                    } else if (matchFormat2) {
                        let d = matchFormat2[1]; 
                        dateStr = d.replace(/-/g, '.').substr(5); 
                        rawDateVal = d.replace(/-/g, '');
                        desc = cleanLine.substring(10);
                    }

                    if (desc.includes('å…Œæ›') || desc.includes('ä½¿ç”¨')) {
                        type = 'use';
                        let ptMatch = desc.match(/ä½¿ç”¨(\d+)é»/); 
                        if (ptMatch) points = "-" + ptMatch[1];
                        desc = desc.replace(/ä½¿ç”¨\d+é»/, "").replace(/å…Œæ›/, "").trim(); 
                    } else {
                        type = 'earn';
                        let ptMatch = desc.match(/ç²å¾—(\d+)é»/);
                        if (ptMatch) points = " " + ptMatch[1];
                        if(desc.includes('æ¶ˆè²»')) {
                            let moneyMatch = desc.match(/(\d+)å…ƒ/);
                            if(moneyMatch) desc = `æ¶ˆè²» ${moneyMatch[1]}å…ƒ`; 
                            else desc = "æ¶ˆè²»ç´¯ç©";
                        }
                    }
                    records.push({ date: dateStr, desc: desc, points: points, type: type, rawSort: rawDateVal });
                });

                records.sort((a, b) => b.rawSort.localeCompare(a.rawSort));
                
                if (records.length > 12) records = records.slice(0, 12); 

                if (records.length === 0) {
                     listContainer.innerHTML = `<div style="margin-top:50px; color:#aaa; text-align:center;">NO RECORDS</div>`;
                } else {
                    records.forEach(rec => {
                        let div = document.createElement('div');
                        div.className = 'row';
                        
                        let ptClass = rec.type === 'earn' ? 'p-plus' : 'p-minus';
                        if(rec.type==='none') ptClass = '';
                        let descClass = rec.type === 'use' ? 'desc desc-use' : 'desc';

                        div.innerHTML = `
                            <div class="date">${rec.date}</div>
                            <div class="dots"></div>
                            <div class="${descClass}">${rec.desc}</div>
                            <div class="dots"></div>
                            <div class="points ${ptClass}">${rec.points}</div>
                        `;
                        listContainer.appendChild(div);
                    });
                }
            }
        }

        function downloadImage() {
            const node = document.getElementById('capture-frame');
            const btn = document.querySelector('.btn-dl');
            const userName = document.getElementById('displayUser').innerText;
            if (userName === "---" || userName === "") { alert("è«‹å…ˆé¸æ“‡å®¢äººï¼"); return; }
            
            const originalText = btn.innerText;
            btn.innerText = "è£½ä½œä¸­..."; 
            btn.disabled = true; 
            window.scrollTo(0,0);
            
            // ğŸ”¥ğŸ”¥ğŸ”¥ ä¿®æ”¹é» 5ï¼šæˆªåœ–ç¬é–“ï¼Œå…ˆæŠŠç¸®å°æ•ˆæœæ‹¿æ‰ï¼Œè®“å®ƒæ¢å¾©ã€Œé›»è…¦ç‰ˆã€å¤§å° ğŸ”¥ğŸ”¥ğŸ”¥
            const currentTransform = node.style.transform;
            const currentMargin = node.style.marginBottom;
            
            // æš«æ™‚ç§»é™¤ç¸®æ”¾
            node.style.transform = 'none';
            node.style.margin = '0'; 
            
            html2canvas(node, { 
                scale: 2, 
                useCORS: true, 
                allowTaint: true, 
                backgroundColor: null,
                // ğŸ”¥ å¼·åˆ¶å‘Šè¨´ html2canvas ç•«å¸ƒè¦é€™éº¼å¯¬ï¼Œé¿å…è¢«æ‰‹æ©Ÿè¦–çª—å¯¬åº¦å½±éŸ¿
                width: 700,
                windowWidth: 700 
            }).then(canvas => {
                let link = document.createElement('a');
                link.download = `ç®±åº­é›†é»å¡_${userName}.jpg`;
                link.href = canvas.toDataURL("image/jpeg", 0.95);
                document.body.appendChild(link); link.click(); document.body.removeChild(link);
                
                btn.innerText = originalText; btn.disabled = false;

                // ğŸ”¥ æˆªåœ–å®Œç•¢ï¼ŒæŠŠæ‰‹æ©Ÿé è¦½çš„ç¸®æ”¾æ•ˆæœåŠ å›å»
                node.style.transform = currentTransform;
                node.style.marginBottom = currentMargin;
                
            }).catch(err => { 
                console.error(err); 
                alert("ä¸‹è¼‰å¤±æ•—"); 
                btn.innerText = originalText; 
                btn.disabled = false; 

                // å¤±æ•—ä¹Ÿè¦å¾©åŸ
                node.style.transform = currentTransform;
                node.style.marginBottom = currentMargin;
            });
        }
    </script>
</body>
</html>
