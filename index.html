<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®±åº­å…¥å¤¢ - é›†é»æ‰‹å¸³ç”Ÿæˆå™¨</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        /* === å…¨ç«™åŸºç¤è¨­å®š === */
        body {
            font-family: 'Noto Serif TC', serif;
            background-color: #f4f4f4;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            color: #555;
        }

        /* === æ§åˆ¶é¢æ¿ (åº—å“¡æ“ä½œå€) === */
        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            text-align: center;
            width: 100%;
            max-width: 500px;
        }
        input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: inherit;
            width: 60%;
        }
        button {
            padding: 10px 20px;
            background: #a1c4fd;
            border: none;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-family: inherit;
            transition: 0.3s;
        }
        button:hover { background: #84fab0; }

        /* === æ”¶æ“šå¡ç‰‡è¨­è¨ˆ (åƒè€ƒåƒè€ƒåœ–é¢¨æ ¼) === */
        #receipt-canvas {
            width: 450px; /* å¡ç‰‡å¯¬åº¦ */
            min-height: 600px;
            background: white;
            /* æ¨¡æ“¬æ›¸æœ¬ç´™å¼µè³ªæ„Ÿ */
            background-image: 
                linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.9)),
                url('data:image/svg+xml;utf8,<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg"><text x="10" y="50" style="font-size:20px;opacity:0.03">Hakoniwa</text></svg>');
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* èƒŒæ™¯è£é£¾ï¼šæ·¡å½©æ¼¸å±¤ */
        .bg-deco-top {
            position: absolute;
            top: -50px; left: -50px;
            width: 300px; height: 300px;
            background: radial-gradient(circle, #fad0c4 0%, transparent 70%);
            opacity: 0.6;
            z-index: 0;
        }
        .bg-deco-bottom {
            position: absolute;
            bottom: -50px; right: -50px;
            width: 350px; height: 350px;
            background: radial-gradient(circle, #a1c4fd 0%, transparent 70%);
            opacity: 0.5;
            z-index: 0;
        }

        /* å…§å®¹ä½ˆå±€ */
        .card-content {
            position: relative;
            z-index: 1;
            padding: 40px;
            flex-grow: 1;
            display: flex;
        }

        /* å·¦å´ï¼šç›´æ’æ¨™é¡Œå€ */
        .sidebar {
            width: 60px;
            border-right: 1px solid #eee;
            margin-right: 25px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .vertical-title {
            writing-mode: vertical-rl; /* ç›´æ’æ–‡å­— */
            text-orientation: mixed;
            font-size: 28px;
            letter-spacing: 8px;
            color: #8faecf; /* æ·¡ç°è—è‰² */
            font-weight: 300;
        }
        .author-sign {
            margin-top: 20px;
            font-size: 10px;
            color: #bbb;
            text-transform: uppercase;
            letter-spacing: 2px;
            writing-mode: vertical-rl;
        }

        /* å³å´ï¼šç´€éŒ„åˆ—è¡¨å€ */
        .main-area {
            flex-grow: 1;
        }
        .user-info {
            font-size: 14px;
            color: #aaa;
            margin-bottom: 20px;
            text-align: right;
            border-bottom: 1px solid #f0f0f0;
            padding-bottom: 10px;
        }
        .record-list {
            list-style: none;
            padding: 0;
            margin: 0;
            font-size: 13px;
            line-height: 2.2; /* å¯¬é¬†è¡Œè· */
        }
        .record-list li {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px dashed #f5f5f5;
        }
        .date { color: #ccc; margin-right: 10px; font-family: monospace; }
        .desc { color: #666; }
        .points-earn { color: #84fab0; font-weight: bold; } /* ç²å¾—é»æ•¸é¡è‰² */
        .points-use { color: #fad0c4; font-weight: bold; } /* ä½¿ç”¨é»æ•¸é¡è‰² */

        /* åº•éƒ¨ç¸½çµå€ */
        .footer-area {
            position: relative;
            z-index: 1;
            padding: 20px 40px;
            text-align: right;
        }
        .total-label {
            font-size: 12px;
            color: #ccc;
            letter-spacing: 2px;
        }
        .total-score {
            font-size: 42px;
            color: #a1c4fd;
            font-weight: 300;
        }
        .footer-note {
            font-size: 10px;
            color: #ddd;
            margin-top: 5px;
            text-align: center;
        }
        
        /* è£é£¾æ€§çš„å°æ˜Ÿæ˜Ÿ */
        .star { position: absolute; color: #ddd; opacity: 0.5; font-size: 10px; }
    </style>
</head>
<body>

    <div class="controls">
        <h3>â˜ï¸ ç®±åº­å…¥å¤¢ãƒ»é›†é»æ«ƒå°</h3>
        <p style="font-size:12px; color:#888;">è¼¸å…¥å™—æµª ID å³å¯è‡ªå‹•ç”Ÿæˆæ”¶æ“š</p>
        <input type="text" id="userIdInput" placeholder="è«‹è¼¸å…¥å™—æµª ID (ä¾‹å¦‚: namida127_draw)">
        <button onclick="generateReceipt()">ğŸ” ç”Ÿæˆæ”¶æ“š</button>
        <button onclick="downloadImage()" style="background:#fad0c4; margin-left:10px;">â¬‡ï¸ ä¸‹è¼‰åœ–ç‰‡</button>
    </div>

    <div id="receipt-canvas">
        <div class="bg-deco-top"></div>
        <div class="bg-deco-bottom"></div>
        
        <div class="star" style="top:50px; left:80px;">âœ¦</div>
        <div class="star" style="bottom:100px; left:40px;">âœ¦</div>
        <div class="star" style="top:150px; right:50px;">*</div>

        <div class="card-content">
            <div class="sidebar">
                <div class="vertical-title">ç®±åº­å…¥å¤¢</div>
                <div class="author-sign">Hakoniwa Irume</div>
                <div class="vertical-title" style="font-size:16px; margin-top:30px; color:#ddd;">é›†é»æ‰‹å¸³</div>
            </div>

            <div class="main-area">
                <div class="user-info">Guest: @<span id="displayUser">---</span></div>
                
                <ul class="record-list" id="recordList">
                    <li><span class="desc">ç­‰å¾…æŸ¥è©¢ä¸­...</span></li>
                </ul>
            </div>
        </div>

        <div class="footer-area">
            <div class="total-label">CURRENT POINTS</div>
            <div class="total-score" id="totalPoints">0</div>
            <div class="footer-note">å…·é«”å…Œæ›è¦å‰‡è«‹è‡³ç½®é ‚å™— (å›é¥‹ç¦åˆ©)</div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIG: è«‹åœ¨é€™è£¡è²¼ä¸Šä½ ç¬¬ä¸€æ­¥å–å¾—çš„ CSV é€£çµ
        // ==========================================
        const SHEET_CONSUME_URL = 'è«‹è²¼ä¸Šæ¶ˆè²»ç´€éŒ„çš„CSVé€£çµ'; 
        const SHEET_REDEEM_URL = 'è«‹è²¼ä¸Šå…Œæ›ç´€éŒ„çš„CSVé€£çµ';
        // ==========================================

        let consumeData = [];
        let redeemData = [];

        // åˆå§‹åŒ–ï¼šè¼‰å…¥ Google Sheet è³‡æ–™
        window.onload = function() {
            loadData(SHEET_CONSUME_URL, data => consumeData = data);
            loadData(SHEET_REDEEM_URL, data => redeemData = data);
        };

        function loadData(url, callback) {
            if(url.includes('è«‹è²¼ä¸Š')) return; // é˜²å‘†
            Papa.parse(url, {
                download: true,
                header: true, // å‡è¨­ç¬¬ä¸€è¡Œæ˜¯æ¨™é¡Œ
                complete: function(results) {
                    callback(results.data);
                    console.log("Data loaded:", results.data);
                }
            });
        }

        function generateReceipt() {
            const userId = document.getElementById('userIdInput').value.trim();
            if (!userId) { alert("è«‹è¼¸å…¥ IDï¼"); return; }
            if (consumeData.length === 0) { alert("è³‡æ–™å°šæœªè¼‰å…¥ï¼Œè«‹ç¨å¾Œå†è©¦æˆ–æª¢æŸ¥ CSV é€£çµã€‚"); return; }

            document.getElementById('displayUser').innerText = userId;
            const listContainer = document.getElementById('recordList');
            listContainer.innerHTML = '';

            let totalPoints = 0;
            let allRecords = [];

            // 1. è™•ç†æ¶ˆè²»ç´€éŒ„
            // å‡è¨­ CSV æ¬„ä½åç¨±åˆ†åˆ¥æ˜¯ (è«‹æ ¹æ“šä½ çš„å¯¦éš› CSV æ¨™é¡Œä¿®æ”¹)ï¼š
            // IDæ¬„ä½å: 'ID', æ—¥æœŸæ¬„ä½å: 'æ—¥æœŸ', é‡‘é¡æ¬„ä½å: 'é‡‘é¡'
            // *å¦‚æœä¸ç¢ºå®šï¼Œå¯ä»¥åœ¨ç€è¦½å™¨ Console çœ‹åˆ°å°å‡ºçš„ data
            
            // ä¸‹é¢ç”¨ ColumnIndex ä¾†æŠ“æ¯”è¼ƒä¿éšª (0=A, 1=B, 2=C...)
            // PapaParse è‹¥ç„¡ header:true å‰‡å›å‚³é™£åˆ—
            // é€™è£¡å‡è¨­æœ‰ headerï¼Œéœ€æ ¹æ“šä½ çš„è¡¨æ ¼å¯¦éš›æ¨™é¡Œä¿®æ”¹
            // ç‚ºäº†æ–¹ä¾¿ï¼Œé€™è£¡æ”¹å¯«æˆç°¡å–®éæ¿¾é‚è¼¯
            
            consumeData.forEach(row => {
                // ç‚ºäº†é€šç”¨æ€§ï¼Œé€™è£¡å‡è¨­ ID åœ¨ 'A' æ¬„ä½ (row['ID'] æˆ– row[0])
                // ä½ å¯èƒ½éœ€è¦æ ¹æ“šå¯¦éš› CSV çš„æ¨™é ­åç¨±ä¿®æ”¹é€™è£¡
                let rID = row['ID'] || row[Object.keys(row)[0]]; 
                let rDate = row['æ—¥æœŸ'] || row[Object.keys(row)[1]];
                let rMoney = row['é‡‘é¡'] || row[Object.keys(row)[2]];

                if (rID == userId) {
                    let pts = Math.floor(parseInt(rMoney) / 800); // ä½ çš„å…¬å¼ logic
                    totalPoints += pts;
                    allRecords.push({
                        type: 'earn',
                        date: formatDate(rDate),
                        text: `ç´¯ç©æ¶ˆè²» ${rMoney} å…ƒ`,
                        points: pts
                    });
                }
            });

            // 2. è™•ç†å…Œæ›ç´€éŒ„
            redeemData.forEach(row => {
                let rID = row['ID'] || row[Object.keys(row)[0]];
                let rDate = row['æ—¥æœŸ'] || row[Object.keys(row)[1]];
                let rItem = row['é …ç›®'] || row[Object.keys(row)[2]];
                let rCost = row['é»æ•¸'] || row[Object.keys(row)[3]];

                if (rID == userId) {
                    let cost = parseInt(rCost);
                    totalPoints -= cost;
                    allRecords.push({
                        type: 'use',
                        date: formatDate(rDate),
                        text: `å…Œæ› ${rItem}`,
                        points: cost
                    });
                }
            });

            // 3. æ’åº (æ—¥æœŸæ–° -> èˆŠ)
            allRecords.sort((a, b) => b.date.localeCompare(a.date));

            // 4. æ¸²æŸ“åˆ°ç•«é¢ä¸Š
            if (allRecords.length === 0) {
                listContainer.innerHTML = '<li><span class="desc">ç›®å‰æ²’æœ‰ç´€éŒ„</span></li>';
            } else {
                allRecords.forEach(rec => {
                    let pointHtml = rec.type === 'earn' 
                        ? `<span class="points-earn">+${rec.points}</span>` 
                        : `<span class="points-use">-${rec.points}</span>`;
                    
                    let html = `
                        <span class="date">${rec.date}</span>
                        <span class="desc">${rec.text}</span>
                        ${pointHtml}
                    `;
                    let li = document.createElement('li');
                    li.innerHTML = html;
                    listContainer.appendChild(li);
                });
            }

            document.getElementById('totalPoints').innerText = totalPoints;
        }

        // è¼”åŠ©ï¼šæ—¥æœŸæ ¼å¼åŒ– (YYMMDD)
        function formatDate(dateStr) {
            // å˜—è©¦è§£ææ—¥æœŸï¼Œå¦‚æœæ ¼å¼ä¸ä¸€å¯èƒ½éœ€è¦èª¿æ•´
            let d = new Date(dateStr);
            if (isNaN(d.getTime())) return dateStr; // è§£æå¤±æ•—å°±å›å‚³åŸå­—ä¸²
            let yy = d.getFullYear().toString().substr(-2);
            let mm = (d.getMonth() + 1).toString().padStart(2, '0');
            let dd = d.getDate().toString().padStart(2, '0');
            return `${yy}${mm}${dd}`;
        }

        // ä¸‹è¼‰åœ–ç‰‡
        function downloadImage() {
            const node = document.getElementById('receipt-canvas');
            html2canvas(node, { scale: 2 }).then(canvas => {
                let link = document.createElement('a');
                link.download = 'é›†é»å¡_' + document.getElementById('displayUser').innerText + '.jpg';
                link.href = canvas.toDataURL("image/jpeg", 0.9);
                link.click();
            });
        }
    </script>
</body>
</html>
