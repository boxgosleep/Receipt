<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®±åº­å…¥å¤¢ - é›†é»æ‰‹å¸³</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* === åŸºç¤è¨­å®š === */
        body {
            font-family: 'Noto Serif TC', serif;
            background-color: #eef2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            margin: 0;
            color: #555;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 20px;
            text-align: center;
            width: 90%;
            max-width: 400px;
        }
        select { padding: 10px; border: 1px solid #a1c4fd; border-radius: 5px; width: 100%; font-family: inherit; margin-bottom: 10px; cursor: pointer; }
        .btn-dl { background: #b4c6e7; color: white; border: none; padding: 10px 30px; border-radius: 20px; cursor: pointer; font-weight: bold; transition: 0.2s;}
        .btn-dl:hover { background: #8faecf; transform: translateY(-2px); }

        /* === å¡ç‰‡æœ¬é«” (æ”¹ç‚º min-heightï¼Œè®“å®ƒèƒ½è‡ªå‹•é•·é«˜) === */
        #receipt-canvas {
            width: 500px;
            min-height: 750px; /* æœ€å°é«˜åº¦ */
            height: auto;      /* è‡ªå‹•é•·é«˜ */
            background-color: #fff;
            position: relative;
            overflow: visible; /* å…è¨±å…§å®¹æ’é–‹ */
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: flex;
        }

        /* === èƒŒæ™¯æ¼¸å±¤ === */
        .bg-gradient-pink {
            position: absolute;
            top: -150px; left: -150px;
            width: 500px; height: 500px;
            background: radial-gradient(circle, rgba(255,228,225,0.7) 0%, rgba(255,255,255,0) 70%);
            z-index: 0;
        }
        .bg-gradient-blue {
            position: absolute;
            bottom: -150px; right: -150px;
            width: 600px; height: 600px;
            background: radial-gradient(circle, rgba(220,240,255,0.7) 0%, rgba(255,255,255,0) 70%);
            z-index: 0;
        }

        /* === å·¦å´æ¨™é¡Œ === */
        .sidebar {
            width: 90px;
            /* è®“é‚Šæ¬„è·Ÿè‘—å¡ç‰‡ä¸€èµ·é•·é«˜ */
            min-height: 100%; 
            border-right: 1px solid rgba(0,0,0,0.05);
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding-top: 50px;
        }

        .vertical-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        .v-char {
            font-size: 36px;
            color: #7b9cc4;
            font-weight: 500;
        }
        
        .v-eng {
            transform: rotate(90deg);
            font-size: 11px;
            letter-spacing: 2px;
            color: #aaa;
            text-transform: uppercase;
            white-space: nowrap;
            margin-top: 80px;
            margin-bottom: 40px;
        }

        .sidebar-footer {
            /* å›ºå®šåœ¨åº•éƒ¨ */
            margin-top: auto; 
            padding-bottom: 40px; /* ç•™é»ç©ºé–“ */
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .v-small {
            font-size: 14px;
            color: #ccc;
        }

        /* === å³å´å…§å®¹ === */
        .main-content {
            flex: 1;
            padding: 40px 30px;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1;
        }

        .header-guest {
            text-align: right;
            font-size: 16px;
            color: #aaa;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        /* åˆ—è¡¨å€ */
        .list-container {
            flex: 1;
            margin-bottom: 20px;
        }
        .record-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            padding: 10px 0;
            border-bottom: 1px dashed #f5f5f5;
            color: #666;
            line-height: 1.5;
        }
        .row-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .date {
            font-family: 'Courier New', monospace;
            color: #ccc;
            font-weight: bold;
            font-size: 12px;
            min-width: 60px; /* ç¢ºä¿æ—¥æœŸå°é½Š */
        }
        .desc {
            /* é˜²æ­¢æ–‡å­—éé•·ç ´ç‰ˆï¼Œæ”¹ç‚ºè‡ªå‹•æ›è¡Œ */
            max-width: 180px;
            word-wrap: break-word; 
        }
        
        /* é»æ•¸é¡è‰² */
        .pts-plus { color: #8faecf; font-weight: bold; white-space: nowrap; }
        .pts-minus { color: #f8b3c6; font-weight: bold; white-space: nowrap; }

        /* åº•éƒ¨ç¸½åˆ† */
        .footer-area {
            text-align: right;
            margin-top: auto;
            border-top: 2px solid #f9f9f9; /* åŠ å€‹åˆ†éš”ç·š */
            padding-top: 20px;
        }
        .lbl { font-size: 11px; color: #ccc; letter-spacing: 2px; }
        .big-num { font-size: 60px; color: #a1c4fd; font-weight: 300; line-height: 1; margin-top: 5px; }
        .note { text-align: center; font-size: 10px; color: #ddd; margin-top: 15px; }

    </style>
</head>
<body>

    <div class="controls">
        <h3>â˜ï¸ ç®±åº­å…¥å¤¢ãƒ»é›†é»æ«ƒå°</h3>
        <p id="statusMsg" style="font-size:12px; color:#aaa; margin-bottom:5px;">åˆå§‹åŒ–ä¸­...</p>
        
        <select id="userSelect" onchange="generateReceipt()">
            <option value="">-- è«‹å…ˆè¼‰å…¥è³‡æ–™ --</option>
        </select>
        
        <br>
        <button class="btn-dl" onclick="downloadImage()">â¬‡ï¸ ä¸‹è¼‰åœ–ç‰‡</button>
    </div>

    <div id="receipt-canvas">
        <div class="bg-gradient-pink"></div>
        <div class="bg-gradient-blue"></div>

        <div class="sidebar">
            <div class="vertical-box">
                <span class="v-char">ç®±</span>
                <span class="v-char">åº­</span>
                <span class="v-char">å…¥</span>
                <span class="v-char">å¤¢</span>
            </div>
            
            <div class="v-eng">Hakoniwa Irume</div>

            <div class="sidebar-footer">
                <span class="v-small">é›†</span>
                <span class="v-small">é»</span>
                <span class="v-small">æ‰‹</span>
                <span class="v-small">å¸³</span>
            </div>
        </div>

        <div class="main-content">
            <div class="header-guest">
                Guest: @<span id="displayUser">---</span>
            </div>

            <div class="list-container" id="recordList">
                <div style="color:#ddd; text-align:center; margin-top:50px;">
                    è«‹é¸æ“‡å®¢äºº ID<br>
                    <span style="font-size:10px; color:#eee;">(è‹¥ç„¡é¸é …è«‹æª¢æŸ¥ CSV é€£çµ)</span>
                </div>
            </div>

            <div class="footer-area">
                <div class="lbl">CURRENT POINTS</div>
                <div class="big-num" id="totalPoints">0</div>
                <div class="note">å…·é«”å…Œæ›è¦å‰‡è«‹è‡³ç½®é ‚å™— (å›é¥‹ç¦åˆ©)</div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // ğŸ”´ è«‹åœ¨é€™è£¡è²¼ä¸Šæ–°çš„ CSV é€£çµ (è¦æ˜¯ output=csv çµå°¾çš„å–”ï¼)
        // ==========================================
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSRN8TqorraKVjJ3FGYpndM6aUQFQcor-4TzrIG_smGY42hTgteuLL_lvGNMKj1wcYPQ70WMz-iWMpA/pub?output=csv'; 
        // ==========================================

        let globalData = [];

        window.onload = function() {
            if(CSV_URL.includes('è«‹åœ¨é€™è£¡è²¼ä¸Š') || CSV_URL.includes('pubhtml')) {
                document.getElementById('statusMsg').innerText = "âŒ é€£çµéŒ¯èª¤ï¼šè«‹ä½¿ç”¨ .csv é€£çµ";
                alert("é€£çµæ ¼å¼ä¸å°å–”ï¼\nè«‹å» Google Sheet -> ç™¼å¸ƒåˆ°ç¶²è·¯ -> é¸æ“‡ã€Œé›†é»å¡ã€-> é¸æ“‡ã€ŒCSVã€æ ¼å¼ã€‚");
                return;
            }
            fetchAndInit();
        };

        function fetchAndInit() {
            document.getElementById('statusMsg').innerText = "ğŸ”„ æ­£åœ¨è®€å–è³‡æ–™...";
            Papa.parse(CSV_URL, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.data && results.data.length > 0) {
                        globalData = results.data;
                        initDropdown();
                        document.getElementById('statusMsg').innerText = "âœ… è³‡æ–™è¼‰å…¥æˆåŠŸï¼";
                    } else {
                        document.getElementById('statusMsg').innerText = "âš ï¸ è®€å–åˆ°äº†ç©ºè³‡æ–™";
                    }
                },
                error: function(err) {
                    document.getElementById('statusMsg').innerText = "âŒ è®€å–å¤±æ•—";
                    console.error(err);
                }
            });
        }

        function initDropdown() {
            const select = document.getElementById('userSelect');
            select.innerHTML = '<option value="">-- è«‹é¸æ“‡ ID --</option>';
            
            // è‡ªå‹•åµæ¸¬ ID æ¬„ä½ (é˜²æ­¢æ¬„ä½åç¨±æœ‰ç©ºæ ¼)
            let idKey = null;
            if (globalData.length > 0) {
                const keys = Object.keys(globalData[0]);
                // æ‰¾ä¸€å€‹æœ€åƒ "ID" çš„æ¬„ä½
                idKey = keys.find(k => k.toUpperCase().includes('ID')) || keys[0];
            }

            globalData.forEach(row => {
                let val = row[idKey]; // ä½¿ç”¨åµæ¸¬åˆ°çš„ ID æ¬„ä½å
                if (val && val.trim() !== '') {
                    let option = document.createElement('option');
                    option.value = val;
                    option.text = val;
                    select.appendChild(option);
                }
            });
        }

        function generateReceipt() {
            const userId = document.getElementById('userSelect').value;
            const listContainer = document.getElementById('recordList');
            
            if (!userId) {
                document.getElementById('displayUser').innerText = "---";
                document.getElementById('totalPoints').innerText = "0";
                listContainer.innerHTML = '';
                return;
            }

            document.getElementById('displayUser').innerText = userId;
            listContainer.innerHTML = ''; 

            // å°‹æ‰¾å°æ‡‰çš„ User
            // åŒæ¨£ä½¿ç”¨è‡ªå‹•åµæ¸¬çš„ ID æ¬„ä½
            let idKey = Object.keys(globalData[0]).find(k => k.toUpperCase().includes('ID')) || Object.keys(globalData[0])[0];
            const userRow = globalData.find(row => row[idKey] == userId);

            if (userRow) {
                // 1. è¨­å®šç¸½åˆ† (å˜—è©¦æŠ“å– "é»æ•¸" ç›¸é—œæ¬„ä½)
                let pointKey = Object.keys(userRow).find(k => k.includes('é»æ•¸')) || 'ç›®å‰é»æ•¸';
                document.getElementById('totalPoints').innerText = userRow[pointKey] || "0";

                // 2. è§£ææ­·å²ç´€éŒ„
                // å˜—è©¦æŠ“å– "æ­·å²" æˆ– "ç´€éŒ„" ç›¸é—œæ¬„ä½
                let historyKey = Object.keys(userRow).find(k => k.includes('æ­·å²') || k.includes('ç´€éŒ„')) || 'æ¶ˆè²»æ­·å²';
                const rawHistory = userRow[historyKey] || "";

                // === é€™è£¡æ˜¯æœ€å¼·è§£æé‚è¼¯ ===
                // å®ƒå¯ä»¥è™•ç†æ›è¡Œç¬¦è™Ÿï¼Œä¹Ÿå¯ä»¥è™•ç† "- " ç¬¦è™Ÿ
                const rawLines = rawHistory.split(/[\n\r]+/); 
                let records = [];

                rawLines.forEach(line => {
                    let cleanLine = line.trim();
                    // å»æ‰é–‹é ­çš„ "- "
                    cleanLine = cleanLine.replace(/^-\s*/, '');
                    if (cleanLine.length < 5) return;

                    // æ”¯æ´å…©ç¨®æ—¥æœŸæ ¼å¼ï¼š
                    // 1. YYMMDD (ä¾‹å¦‚ 251127) -> ä½ çš„ Excel æ ¼å¼
                    // 2. YYYY-MM-DD (ä¾‹å¦‚ 2025-11-27)
                    
                    let dateStr = "??.??.??";
                    let rawDateVal = "0";
                    let desc = cleanLine;
                    let type = 'earn';
                    let points = '';

                    // æ¸¬è©¦æ ¼å¼ 1: 6ä½æ•¸å­—é–‹é ­ (251127)
                    let matchFormat1 = cleanLine.match(/^(\d{6})/);
                    // æ¸¬è©¦æ ¼å¼ 2: æ¨™æº–æ—¥æœŸ (2025-11-27)
                    let matchFormat2 = cleanLine.match(/^(\d{4}-\d{2}-\d{2})/);

                    if (matchFormat1) {
                        let d = matchFormat1[1];
                        dateStr = `${d.substr(0,2)}.${d.substr(2,2)}.${d.substr(4,2)}`; // 25.11.27
                        rawDateVal = d;
                        desc = cleanLine.substring(6); // å»æ‰æ—¥æœŸå¾Œçš„æ–‡å­—
                    } else if (matchFormat2) {
                        let d = matchFormat2[1]; // 2025-11-27
                        dateStr = d.replace(/-/g, '.').substr(2); // 25.11.27
                        rawDateVal = d.replace(/-/g, '');
                        desc = cleanLine.substring(10);
                    } else {
                        // æ²’æŠ“åˆ°æ—¥æœŸï¼Œå°±æ•´è¡Œé¡¯ç¤ºï¼Œä¸è¦ä¸Ÿæ‰
                        desc = cleanLine;
                    }

                    // åˆ¤æ–·æ˜¯æ¶ˆè²»é‚„æ˜¯å…Œæ›
                    if (desc.includes('å…Œæ›') || desc.includes('ä½¿ç”¨')) {
                        type = 'use';
                        // å˜—è©¦æŠ“é»æ•¸æ•¸å­— (ä¾‹å¦‚: ä½¿ç”¨5é»)
                        let ptMatch = desc.match(/(\d+)é»/);
                        if (ptMatch) points = "-" + ptMatch[1];
                    } else {
                        type = 'earn';
                        // å˜—è©¦æŠ“é»æ•¸ (ä¾‹å¦‚: ç²å¾—3é»)
                        let ptMatch = desc.match(/ç²å¾—(\d+)é»/);
                        if (ptMatch) points = "+" + ptMatch[1];
                        
                        // ç°¡åŒ–æè¿°ï¼šåªé¡¯ç¤ºã€Œæ¶ˆè²»ç´¯ç©ã€æˆ–æ˜¯æŠŠé‡‘é¡æŠ“å‡ºä¾†
                        if(desc.includes('æ¶ˆè²»')) {
                            let moneyMatch = desc.match(/(\d+)å…ƒ/);
                            if(moneyMatch) desc = `æ¶ˆè²» $${moneyMatch[1]}`;
                            else desc = "æ¶ˆè²»ç´¯ç©";
                        }
                    }

                    records.push({ date: dateStr, desc: desc, points: points, type: type, rawSort: rawDateVal });
                });

                // æ’åº (æ–°çš„åœ¨ä¸Šé¢)
                records.sort((a, b) => b.rawSort.localeCompare(a.rawSort));

                if (records.length === 0) {
                     // çœŸçš„æ²’æŠ“åˆ°ï¼Œå°±é¡¯ç¤ºåŸå§‹æ–‡å­—
                     listContainer.innerHTML = `<div style="padding:10px; color:#aaa;">${rawHistory || 'å°šç„¡ç´€éŒ„'}</div>`;
                } else {
                    records.forEach(rec => {
                        let div = document.createElement('div');
                        div.className = 'record-row';
                        let ptsClass = rec.type === 'earn' ? 'pts-plus' : 'pts-minus';
                        
                        div.innerHTML = `
                            <div class="row-left">
                                <span class="date">${rec.date}</span>
                                <span class="desc">${rec.desc}</span>
                            </div>
                            <div class="${ptsClass}">${rec.points}</div>
                        `;
                        listContainer.appendChild(div);
                    });
                }
            }
        }

        // === ä¿®æ­£å¾Œçš„ä¸‹è¼‰å‡½æ•¸ ===
        function downloadImage() {
            const node = document.getElementById('receipt-canvas');
            const btn = document.querySelector('.btn-dl');
            const userName = document.getElementById('displayUser').innerText;
            
            // 1. é˜²å‘†
            if (userName === "---" || userName === "") {
                alert("è«‹å…ˆé¸æ“‡ä¸€ä½å®¢äººæ‰èƒ½ä¸‹è¼‰å–”ï¼");
                return;
            }

            // 2. UI å›é¥‹
            const originalText = btn.innerText;
            btn.innerText = "ğŸ“¸ è™•ç†ä¸­...";
            btn.disabled = true; 
            
            // 3. é—œéµä¿®æ­£ï¼šæ²å‹•åˆ°é ‚éƒ¨
            window.scrollTo(0,0);
            
            html2canvas(node, { 
                scale: 2, 
                useCORS: true,
                allowTaint: true,
                backgroundColor: "#ffffff", 
                scrollY: 0, 
            }).then(canvas => {
                let link = document.createElement('a');
                link.download = `ç®±åº­æ‰‹å¸³_${userName}.jpg`;
                link.href = canvas.toDataURL("image/jpeg", 0.95);
                document.body.appendChild(link); 
                link.click();
                document.body.removeChild(link); 
                
                btn.innerText = originalText;
                btn.disabled = false;
            }).catch(err => {
                console.error("æˆªåœ–å¤±æ•—:", err);
                alert("åœ–ç‰‡ç”Ÿæˆå¤±æ•— QQ\nè«‹æŒ‰ F12 çœ‹ Console éŒ¯èª¤è¨Šæ¯ã€‚");
                btn.innerText = originalText;
                btn.disabled = false;
            });
        }
    </script>
</body>
</html>
