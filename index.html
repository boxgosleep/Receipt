<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®±åº­å…¥å¤¢ - é«˜ç´šé›†é»å¡</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&family=Cinzel:wght@700&family=Courier+Prime:wght@400;700&display=swap" rel="stylesheet">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>

    <style>
        /* === å…¨å±€é‡ç½® === */
        * { box-sizing: border-box; }
        body {
            font-family: 'Noto Serif TC', serif;
            background-color: #111; 
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 0;
            margin: 0;
            color: #333;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* === UI æ§åˆ¶é¢æ¿ === */
        .controls {
            background: rgba(30, 30, 30, 0.8);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px 25px;
            border-radius: 20px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            align-items: center;
            color: #aaa;
            font-size: 14px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            width: 90%;
            max-width: 600px;
            position: sticky;
            top: 20px;
            z-index: 100;
        }

        select { 
            padding: 10px 15px;
            border: 1px solid #555;
            background: #222;
            border-radius: 10px; 
            color: #fff;
            font-size: 14px;
            outline: none;
            cursor: pointer;
            flex: 1;
            min-width: 150px;
        }

        .btn-dl { 
            background: #e0e0e0;
            color: #111; 
            border: none; 
            padding: 10px 25px; 
            border-radius: 10px; 
            cursor: pointer; 
            font-weight: 700; 
            transition: 0.2s;
            font-size: 14px;
            white-space: nowrap;
            box-shadow: 0 4px 10px rgba(255,255,255,0.1);
        }
        .btn-dl:hover { background: #fff; transform: translateY(-2px); }
        .btn-dl:disabled { opacity: 0.6; cursor: not-allowed; }

        @media (max-width: 500px) {
            .controls { flex-direction: column; gap: 10px; }
            select, .btn-dl { width: 100%; text-align: center; }
        }

        /* === æˆªåœ–ç¯„åœ === */
        #capture-frame {
            background: radial-gradient(circle at center, #333333 0%, #000000 80%);
            width: 700px !important;
            min-width: 700px;
            min-height: 900px;
            padding: 60px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            transform-origin: top center;
            flex-shrink: 0; 
        }
        
        /* === èˆå°å®¹å™¨ (å¯¬åº¦å›ºå®š 450px) === */
        .stage-container {
            position: relative;
            width: 450px; 
            height: 720px; 
        }

        /* === å¡ç‰‡é€šç”¨è¨­å®š === */
        .card {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
        }

        /* === å…©å´è£é£¾å¡ç‰‡ (ç¶­æŒç›´è§’ï¼ŒèƒŒæ™¯ç°è‰²) === */
        .side-card {
            background: #888;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }
        .side-left { transform: translateX(-15px) translateY(10px); z-index: 5; filter: brightness(0.6); }
        .side-right { transform: translateX(15px) translateY(10px); z-index: 5; filter: brightness(0.6); }

        /* === ä¸­å¤®ä¸»å¡ç‰‡ === */
        .main-card {
            z-index: 10;
            display: flex;
            flex-direction: column;
            transform: translateY(0);
            /* è®“å®¹å™¨æœ¬èº«é€æ˜ï¼Œåªé¡¯ç¤ºé™°å½± */
            background: transparent;
            /* ä½¿ç”¨ drop-shadow è®“é™°å½±è·Ÿéš¨é‹¸é½’å½¢ç‹€ */
            filter: drop-shadow(0 30px 50px rgba(0,0,0,0.9));
        }

/* =========================================
   ğŸ”¥ğŸ”¥ğŸ”¥ ç´™å¼µè³ªæ„Ÿæ ¸å¿ƒä¿®æ”¹å€ ğŸ”¥ğŸ”¥ğŸ”¥
   ä½¿ç”¨æ··åˆæ¨¡å¼ (overlay) å°‡åº•è‰²èˆ‡å™ªé»æè³ªçµåˆ
========================================= */

/* 1. æœ¬é«” */
.main-card .paper-bg {
    position: absolute;
    top: 10px; bottom: 10px; left: 0; width: 100%; height: calc(100% - 20px); z-index: 1;
    
    /* ğŸ”¥ ä¿®æ”¹ 1: åº•è‰²æ”¹ç‚ºç¨å¾®æ·±ä¸€é»ã€æš–ä¸€é»çš„ç±³è‰²ï¼Œè®“æè³ªæ›´æ˜é¡¯ */
    background-color: #d0c8bc;
    
    /* ä½¿ç”¨ç©©å®šçš„ç°éš PNG æè³ª */
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAMAAAAp4XiDAAAAUVBMVEWFhYWDg4N8fHzMzMxcXFwqKiohISFqampQUFBWVlaLi4mysrJOVk7///+9vb2urq5hYWGampqcnJyTk5O+vr6NjY1ycnKhoaFxcXGqqqqMjIwZ/8iOAAAAG3RSTlMAvv3omvy7Fv7mLz792r6BdPvPv5x5/b2Wlvyb/65tAAAAqUlEQVR4XqWUSw6EMAxDQ0JI+pe5/6kjsUColPzRqLw4sawCwI9x/Oc4t04I5HoTJbOc0/tV1iMxj8c+ptuTmZAUEgAAhDouTVJKBdB19ZxJ4puzErO1f6XGVO2fS2R6/0y1989F8oO/Smnm/4ZVCR8JJwL1OyaBo5eR8J18Qy4j4Ts5Rt9GwnfyDbmN/D85QvBv8g25jYTv5BvSjYTv5BvSjYTv5BvSjYQvBC85pw5sLh0F/QAAAABJRU5ErkJggg==');
    
    /* ğŸ”¥ ä¿®æ”¹ 2: åŠ å…¥æ··åˆæ¨¡å¼ overlayï¼Œå‰µé€ ç´™å¼µè³ªæ„Ÿ */
    background-blend-mode: overlay;
    
    background-size: 100px 100px;
    background-repeat: repeat;
}

/* 2. é ‚éƒ¨é‹¸é½’ (åŒæ­¥å¥—ç”¨è³ªæ„Ÿ) */
.main-card .paper-bg::before {
    content: ''; position: absolute; top: -10px; left: 0; width: 100%; height: 11px;
    
    /* ğŸ”¥ åŒæ­¥åº•è‰²èˆ‡æ··åˆæ¨¡å¼ */
    background-color: #d0c8bc;
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAMAAAAp4XiDAAAAUVBMVEWFhYWDg4N8fHzMzMxcXFwqKiohISFqampQUFBWVlaLi4mysrJOVk7///+9vb2urq5hYWGampqcnJyTk5O+vr6NjY1ycnKhoaFxcXGqqqqMjIwZ/8iOAAAAG3RSTlMAvv3omvy7Fv7mLz792r6BdPvPv5x5/b2Wlvyb/65tAAAAqUlEQVR4XqWUSw6EMAxDQ0JI+pe5/6kjsUColPzRqLw4sawCwI9x/Oc4t04I5HoTJbOc0/tV1iMxj8c+ptuTmZAUEgAAhDouTVJKBdB19ZxJ4puzErO1f6XGVO2fS2R6/0y1989F8oO/Smnm/4ZVCR8JJwL1OyaBo5eR8J18Qy4j4Ts5Rt9GwnfyDbmN/D85QvBv8g25jYTv5BvSjYTv5BvSjYTv5BvSjYQvBC85pw5sLh0F/QAAAABJRU5ErkJggg==');
    background-blend-mode: overlay;
    
    background-size: 100px 100px;

    /* ä¿ç•™é®ç½©è¨­å®š */
    -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='220' viewBox='0 0 300 220'%3E%3Cpath d='M0,220 A150,150 0 0,1 300,220 Z' fill='black'/%3E%3C/svg%3E");
    mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='220' viewBox='0 0 300 220'%3E%3Cpath d='M0,220 A150,150 0 0,1 300,220 Z' fill='black'/%3E%3C/svg%3E");
    -webkit-mask-size: 15px 100%; mask-size: 15px 100%;
    -webkit-mask-repeat: repeat-x; mask-repeat: repeat-x;
}

/* 3. åº•éƒ¨é‹¸é½’ (åŒæ­¥å¥—ç”¨è³ªæ„Ÿ) */
.main-card .paper-bg::after {
    content: ''; position: absolute; bottom: -10px; left: 0; width: 100%; height: 11px;
    
    /* ğŸ”¥ åŒæ­¥åº•è‰²èˆ‡æ··åˆæ¨¡å¼ */
    background-color: #d0c8bc;
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADIAAAAyCAMAAAAp4XiDAAAAUVBMVEWFhYWDg4N8fHzMzMxcXFwqKiohISFqampQUFBWVlaLi4mysrJOVk7///+9vb2urq5hYWGampqcnJyTk5O+vr6NjY1ycnKhoaFxcXGqqqqMjIwZ/8iOAAAAG3RSTlMAvv3omvy7Fv7mLz792r6BdPvPv5x5/b2Wlvyb/65tAAAAqUlEQVR4XqWUSw6EMAxDQ0JI+pe5/6kjsUColPzRqLw4sawCwI9x/Oc4t04I5HoTJbOc0/tV1iMxj8c+ptuTmZAUEgAAhDouTVJKBdB19ZxJ4puzErO1f6XGVO2fS2R6/0y1989F8oO/Smnm/4ZVCR8JJwL1OyaBo5eR8J18Qy4j4Ts5Rt9GwnfyDbmN/D85QvBv8g25jYTv5BvSjYTv5BvSjYTv5BvSjYQvBC85pw5sLh0F/QAAAABJRU5ErkJggg==');
    background-blend-mode: overlay;

    background-size: 100px 100px;

    /* ä¿ç•™é®ç½©è¨­å®š */
    -webkit-mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='220' viewBox='0 0 300 220'%3E%3Cpath d='M0,0 A150,150 0 0,0 300,0 Z' fill='black'/%3E%3C/svg%3E");
    mask-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='300' height='220' viewBox='0 0 300 220'%3E%3Cpath d='M0,0 A150,150 0 0,0 300,0 Z' fill='black'/%3E%3C/svg%3E");
    -webkit-mask-size: 15px 100%; mask-size: 15px 100%;
    -webkit-mask-repeat: repeat-x; mask-repeat: repeat-x;
}

/* =========================================
   ğŸ”¥ ä¿®æ”¹çµæŸ ğŸ”¥
========================================= */

        /* === å·¨å‹èƒŒæ™¯å­— === */
        .giant-text {
            position: absolute;
            top: -45px;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Cinzel', serif;
            font-size: 160px;
            color: #1a1a1a; 
            z-index: 2; 
            white-space: nowrap;
            letter-spacing: -5px;
            font-weight: 700;
            opacity: 0.1; 
        }

        /* === å‰æ™¯å…§å®¹å±¤ === */
        .content-layer {
            position: relative;
            z-index: 20; 
            /* ğŸ”¥ ä¸Šä¸‹ padding è¨­ç‚º 40pxï¼Œç¢ºä¿ä¸æœƒåˆ‡åˆ°é‹¸é½’ */
            padding: 40px 35px;
            flex: 1;
            display: flex;
            flex-direction: column;
            text-align: center;
        }

        .top-header { margin-bottom: 40px; color: #111; }
        .brand-name {
            font-family: 'Cinzel', serif;
            font-size: 10px;
            letter-spacing: 3px;
            color: #666;
            margin-bottom: 5px;
            display: block;
        }
        .card-title {
            font-family: 'Noto Serif TC', serif;
            font-size: 24px;
            font-weight: 700;
            color: #000; 
            letter-spacing: 2px;
        }

        .guest-row {
            font-family: 'Courier Prime', monospace;
            font-size: 11px;
            border-bottom: 1px solid #111;
            padding-bottom: 10px;
            margin-bottom: 40px;
            text-align: center;
            color: #000;
            letter-spacing: 1px;
        }
        .guest-row span { font-weight: 520; }

        .list-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .row {
            display: flex;
            align-items: center; 
            justify-content: space-between;
            font-size: 12px;
            color: #111;
            width: 100%;
        }
        
        .date {
            font-family: 'Courier Prime', monospace;
            font-weight: 700;
            width: 45px; 
            text-align: left;
            flex-shrink: 0;
        }
        
        .dots {
            flex: 1;
            border-bottom: 1px dotted #999;
            margin: 0 8px;
            height: 5px; 
            opacity: 0.5;
        }
        
        .desc {
            font-weight: 500;
            white-space: nowrap; 
            color: #222;
        }
        .desc-use { color: #000; font-weight: 700; }
        
        .points {
            font-family: 'Courier Prime', monospace;
            font-weight: 700;
            width: 25px; 
            text-align: right;
            flex-shrink: 0;
        }
        .p-plus { color: #111; }
        .p-minus { color: #555; } 

        .footer {
            margin-top: auto;
            padding-top: 30px;
            border-top: 2px solid #000;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
        }
        
        .footer-info {
            text-align: left;
            font-size: 9px;
            line-height: 1.6;
            color: #444;
            font-family: 'Courier Prime', monospace;
        }

        .total-box { text-align: right; }
        .lbl {
            padding-bottom: 9px;
            font-size: 9px; 
            text-transform: uppercase; 
            letter-spacing: 1.5px; 
            color: #666;
        }
        .big-num {
            font-family: 'Cinzel', serif;
            font-size: 50px;
            line-height: 1;
            color: #000;
            font-weight: 700;
        }

    </style>
</head>
<body>

    <div class="controls">
        <span style="font-weight:bold;">â˜ï¸ HAKONIWA</span>
        <select id="userSelect" onchange="generateReceipt()">
            <option value="">-- è«‹é¸æ“‡ ID --</option>
        </select>
        <button class="btn-dl" onclick="downloadImage()">ä¸‹è¼‰é›†é»å¡</button>
        <div id="statusMsg" style="width:100%; text-align:center; font-size:11px; margin-top:5px; display:none;">åˆå§‹åŒ–...</div>
    </div>

    <div id="capture-frame">
        <div class="stage-container">
            <div class="card side-card side-left"></div>
            <div class="card side-card side-right"></div>

            <div class="card main-card">
                <div class="paper-bg"></div> <div class="giant-text">HAKONIWA</div>
                <div class="content-layer">
                    <div class="top-header">
                        <span class="brand-name">HAKONIWA IRUME</span>
                        <span class="card-title">é›†é»å¡</span>
                    </div>
                    <div class="guest-row">
                        GUEST NO. <span id="displayUser">---</span>
                    </div>
                    <div class="list-area" id="recordList">
                        <div style="color:#aaa; margin-top:100px; font-size:11px;">
                            WAITING FOR DATA...
                        </div>
                    </div>
                    <div class="footer">
                        <div class="footer-info">
                            OFFICIAL EVENT<br>
                            <span id="issuePrefix">ISSUE</span> <span id="autoDate">....</span>
                        </div>
                        <div class="total-box">
                            <div class="lbl">Total Points</div>
                            <div class="big-num" id="totalPoints">0</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSRN8TqorraKVjJ3FGYpndM6aUQFQcor-4TzrIG_smGY42hTgteuLL_lvGNMKj1wcYPQ70WMz-iWMpA/pub?output=csv';
        let globalData = [];
        
// ... (ä¿ç•™åŸæœ¬çš„ CSV_URL å’Œ globalData) ...

// â˜… ä¿®æ”¹ 1: å¢åŠ ä¸€å€‹å¾ç¶²å€å–å¾—åƒæ•¸çš„ helper
function getQueryParam(param) {
    const urlParams = new URLSearchParams(window.location.search);
    return urlParams.get(param);
}

window.onload = function() {
    updateCurrentDate();
    autoScalePreview();
    window.addEventListener('resize', autoScalePreview);
    
    // éš±è—æ§åˆ¶é¢æ¿ (å¦‚æœæ˜¯è‡ªå‹•åŒ–æˆªåœ–æ¨¡å¼)
    // é€™æ¨£æˆªåœ–å‡ºä¾†æ‰ä¸æœƒæœ‰ä¸Šé¢é‚£å€‹é»‘è‰²çš„æ§åˆ¶æ¢
    if (getQueryParam('mode') === 'clean') {
        document.querySelector('.controls').style.display = 'none';
        document.body.style.backgroundColor = 'transparent'; // è®“èƒŒæ™¯é€æ˜æ–¹ä¾¿å»èƒŒ(é¸ç”¨)
    }

    fetchAndInit(); // å•Ÿå‹•è³‡æ–™è®€å–
};

function fetchAndInit() {
    Papa.parse(CSV_URL, {
        download: true, header: true, skipEmptyLines: true,
        complete: function(results) {
            if (results.data && results.data.length > 0) {
                globalData = results.data;
                initDropdown(); // ä¿æŒåŸæœ¬åŠŸèƒ½
                
                // â˜… ä¿®æ”¹ 2: è³‡æ–™è®€å–å®Œå¾Œï¼Œæª¢æŸ¥ç¶²å€æœ‰æ²’æœ‰æŒ‡å®š user
                const targetUser = getQueryParam('user');
                if (targetUser) {
                    // å¦‚æœæœ‰æŒ‡å®šï¼Œç›´æ¥è¨­å®šé¸å–®ä¸¦è§¸ç™¼ç”Ÿæˆ
                    const select = document.getElementById('userSelect');
                    select.value = targetUser;
                    generateReceipt(); // æ¸²æŸ“å¡ç‰‡
                    
                    // çµ¦ä¸€å€‹è¨Šè™Ÿå‘Šè¨´æˆªåœ–æ©Ÿå™¨äººã€Œæˆ‘å¥½äº†ã€
                    // (é€™æ˜¯ä¸€å€‹éš±è—çš„ divï¼Œæˆªåœ– API å¯ä»¥åµæ¸¬é€™å€‹å…ƒç´ å‡ºç¾æ‰æ‹ç…§)
                    const readyDiv = document.createElement('div');
                    readyDiv.id = 'render-complete';
                    document.body.appendChild(readyDiv);
                }
            }
        }
    });
}

// ... (å…¶é¤˜ generateReceipt ç­‰å‡½å¼ä¿æŒä¸è®Š) ...

        function autoScalePreview() {
            const frame = document.getElementById('capture-frame');
            const screenWidth = window.innerWidth;
            const targetWidth = 720; 

            if (screenWidth < targetWidth) {
                const scale = screenWidth / targetWidth;
                frame.style.transform = `scale(${scale})`;
                frame.style.marginBottom = `-${(1 - scale) * 900}px`;
            } else {
                frame.style.transform = 'none';
                frame.style.marginBottom = '0px';
            }
        }

        function updateCurrentDate() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            document.getElementById('autoDate').innerText = `${year}-${month}`;
        }

        function fetchAndInit() {
            Papa.parse(CSV_URL, {
                download: true, header: true, skipEmptyLines: true,
                complete: function(results) {
                    if (results.data && results.data.length > 0) {
                        globalData = results.data;
                        initDropdown();
                        document.getElementById('statusMsg').innerText = "âœ… è³‡æ–™å°±ç·’";
                        setTimeout(() => { document.getElementById('statusMsg').style.display = 'none'; }, 2000);
                    }
                }
            });
        }

        function initDropdown() {
            const select = document.getElementById('userSelect');
            select.innerHTML = '<option value="">-- è«‹é¸æ“‡ ID --</option>';
            let idKey = Object.keys(globalData[0]).find(k => k.toUpperCase().includes('ID')) || Object.keys(globalData[0])[0];
            globalData.forEach(row => {
                let val = row[idKey]; 
                if (val && val.trim() !== '') {
                    let option = document.createElement('option');
                    option.value = val; option.text = val; select.appendChild(option);
                }
            });
        }

        function generateReceipt() {
            const userId = document.getElementById('userSelect').value;
            const listContainer = document.getElementById('recordList');
            
            if (!userId) {
                document.getElementById('displayUser').innerText = "---";
                document.getElementById('totalPoints').innerText = "0";
                listContainer.innerHTML = '<div style="color:#aaa; margin-top:100px;">WAITING...</div>';
                return;
            }

            document.getElementById('displayUser').innerText = userId;
            listContainer.innerHTML = ''; 

            let idKey = Object.keys(globalData[0]).find(k => k.toUpperCase().includes('ID')) || Object.keys(globalData[0])[0];
            const userRow = globalData.find(row => row[idKey] == userId);
            if (userRow) {
                let pointKey = Object.keys(userRow).find(k => k.includes('é»æ•¸')) || 'ç›®å‰é»æ•¸';
                document.getElementById('totalPoints').innerText = userRow[pointKey] || "0";

                let allHistoryKeys = Object.keys(userRow).filter(k => k.includes('æ­·å²') || k.includes('ç´€éŒ„'));
                let rawHistory = allHistoryKeys.length > 0 ? allHistoryKeys.map(key => userRow[key]).join("\n") : (userRow['æ¶ˆè²»æ­·å²'] || "");
                
                const rawLines = rawHistory.split(/[\n\r]+/);
                let records = [];

               rawLines.forEach(line => {
                    let cleanLine = line.trim().replace(/^-\s*/, '');
                    if (cleanLine.length < 5) return;
                    let dateStr = "??.??"; let rawDateVal = "0"; let desc = cleanLine;
                    let type = 'earn'; let points = '';
                    let matchFormat1 = cleanLine.match(/^(\d{6})/);
                    let matchFormat2 = cleanLine.match(/^(\d{4}-\d{2}-\d{2})/);

                    if (matchFormat1) {
                        let d = matchFormat1[1];
                        dateStr = `${d.substr(2,2)}.${d.substr(4,2)}`; 
                        rawDateVal = d;
                        desc = cleanLine.substring(6);
                    } else if (matchFormat2) {
                        let d = matchFormat2[1]; 
                        dateStr = d.replace(/-/g, '.').substr(5); 
                        rawDateVal = d.replace(/-/g, '');
                        desc = cleanLine.substring(10);
                    }

                    if (desc.includes('å…Œæ›') || desc.includes('ä½¿ç”¨')) {
                        type = 'use';
                        let ptMatch = desc.match(/ä½¿ç”¨(\d+)é»/); 
                        if (ptMatch) points = "-" + ptMatch[1];
                        desc = desc.replace(/ä½¿ç”¨\d+é»/, "").replace(/å…Œæ›/, "").trim();
                    } else {
                        type = 'earn';
                        let ptMatch = desc.match(/ç²å¾—(\d+)é»/);
                        if (ptMatch) points = " " + ptMatch[1];
                        if(desc.includes('æ¶ˆè²»')) {
                            let moneyMatch = desc.match(/(\d+)å…ƒ/);
                            if(moneyMatch) desc = `æ¶ˆè²» ${moneyMatch[1]}å…ƒ`; 
                            else desc = "æ¶ˆè²»ç´¯ç©";
                        }
                    }
                    records.push({ date: dateStr, desc: desc, points: points, type: type, rawSort: rawDateVal });
                });

                records.sort((a, b) => b.rawSort.localeCompare(a.rawSort));
                
                if (records.length > 12) records = records.slice(0, 12);
                if (records.length === 0) {
                     listContainer.innerHTML = `<div style="margin-top:50px; color:#aaa; text-align:center;">NO RECORDS</div>`;
                } else {
                    records.forEach(rec => {
                        let div = document.createElement('div');
                        div.className = 'row';
                        let ptClass = rec.type === 'earn' ? 'p-plus' : 'p-minus';
                        if(rec.type==='none') ptClass = '';
                        let descClass = rec.type === 'use' ? 'desc desc-use' : 'desc';

                        div.innerHTML = `
                            <div class="date">${rec.date}</div>
                            <div class="dots"></div>
                            <div class="${descClass}">${rec.desc}</div>
                            <div class="dots"></div>
                            <div class="points ${ptClass}">${rec.points}</div>
                        `;
                        listContainer.appendChild(div);
                    });
                }
            }
        }

   function downloadImage() {
    const node = document.getElementById('capture-frame');
    const btn = document.querySelector('.btn-dl');
    const userName = document.getElementById('displayUser').innerText;

    if (userName === "---" || userName === "") { alert("è«‹å…ˆé¸æ“‡å®¢äººï¼"); return; }

    const originalText = btn.innerText;
    btn.innerText = "è£½ä½œä¸­...";
    btn.disabled = true;

    const originalTransform = node.style.transform;
    const originalMargin = node.style.marginBottom;

    // æš«æ™‚ç§»é™¤ CSS ç¸®æ”¾ï¼Œé¿å…å¹²æ“¾
    node.style.transform = 'none';
    node.style.margin = '0';

    htmlToImage.toJpeg(node, { 
        quality: 0.95, 
        backgroundColor: '#111111', 
        
        // ğŸ”¥ é—œéµä¿®æ”¹ï¼šè¨­å®š 3 å€è§£æåº¦ï¼Œåœ–ç‰‡æœƒè®Šå¤§ä¸”æ¸…æ™°
        pixelRatio: 3, 
        
        // ğŸ”¥ é—œéµä¿®æ”¹ï¼šä¸éœ€è¦å¼·åˆ¶ scale(1)ï¼Œè®“ pixelRatio å»è™•ç†æ”¾å¤§
        style: { 
            transform: 'none',
            margin: '0'
        } 
    })
    .then(function (dataUrl) {
        let link = document.createElement('a');
        link.download = `ç®±åº­é›†é»å¡_${userName}.jpg`;
        link.href = dataUrl;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        btn.innerText = originalText;
        btn.disabled = false;
        node.style.transform = originalTransform;
        node.style.marginBottom = originalMargin;
    })
    .catch(function (error) {
        console.error('oops, something went wrong!', error);
        alert("ä¸‹è¼‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ§åˆ¶å°éŒ¯èª¤è¨Šæ¯");
        btn.innerText = originalText;
        btn.disabled = false;
        node.style.transform = originalTransform;
        node.style.marginBottom = originalMargin;
    });
}
    </script>
</body>
</html>
