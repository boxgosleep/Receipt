<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>箱庭入夢 - 集點手帳</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        /* === 您的箱庭風格樣式保持不變 === */
        body {
            font-family: 'Noto Serif TC', serif;
            background-color: #f0f2f5;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 30px;
            color: #555;
            margin: 0;
        }
        .controls {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            margin-bottom: 30px;
            text-align: center;
            width: 100%;
            max-width: 400px;
            border: 1px solid #eef;
        }
        .controls h3 { margin-top: 0; color: #8faecf; }
        input { padding: 12px; border: 1px solid #ddd; border-radius: 8px; width: 70%; text-align: center; font-family: inherit; margin-bottom: 10px; }
        button { padding: 10px 25px; border: none; border-radius: 30px; cursor: pointer; font-family: inherit; transition: 0.3s; font-weight: bold; letter-spacing: 1px; }
        .btn-gen { background: #a1c4fd; color: white; }
        .btn-dl { background: #fad0c4; color: white; margin-left: 10px; }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        #receipt-canvas {
            width: 500px; 
            min-height: 700px;
            background: #fff;
            position: relative;
            box-shadow: 0 15px 40px rgba(0,0,0,0.1);
            overflow: hidden;
            display: flex;
            background-image: repeating-linear-gradient(45deg, #fffcfc 25%, transparent 25%, transparent 75%, #fffcfc 75%, #fffcfc), repeating-linear-gradient(45deg, #fffcfc 25%, #fff 25%, #fff 75%, #fffcfc 75%, #fffcfc);
            background-position: 0 0, 10px 10px;
            background-size: 20px 20px;
        }
        .gradient-orb { position: absolute; border-radius: 50%; filter: blur(60px); z-index: 0; }
        .orb-1 { top: -50px; right: -50px; width: 300px; height: 300px; background: rgba(161, 196, 253, 0.4); }
        .orb-2 { bottom: -50px; left: -50px; width: 350px; height: 350px; background: rgba(250, 208, 196, 0.4); }
        .layout-container { position: relative; z-index: 2; width: 100%; display: flex; padding: 40px; }
        .sidebar { width: 70px; border-right: 1px solid rgba(0,0,0,0.05); margin-right: 30px; display: flex; flex-direction: column; justify-content: space-between; align-items: center; padding-top: 20px; padding-bottom: 20px; }
        .vertical-text { writing-mode: vertical-rl; text-orientation: mixed; letter-spacing: 0.8em; color: #8faecf; font-size: 24px; font-weight: 300; }
        .logo-text { writing-mode: vertical-rl; font-size: 10px; letter-spacing: 2px; color: #ccc; text-transform: uppercase; }
        .main-content { flex: 1; display: flex; flex-direction: column; }
        .header-info { text-align: right; margin-bottom: 30px; border-bottom: 2px solid #fad0c4; padding-bottom: 15px; }
        .user-id { font-size: 14px; color: #aaa; letter-spacing: 1px; }
        .user-name { font-size: 22px; color: #555; margin-top: 5px; font-weight: 500; }
        .record-list { list-style: none; padding: 0; margin: 0; flex-grow: 1; }
        .record-item { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 12px; font-size: 13px; border-bottom: 1px dashed #eee; padding-bottom: 8px; }
        .item-date { font-family: 'Courier New', monospace; color: #bbb; margin-right: 10px; font-size: 12px; }
        .item-desc { color: #666; flex: 1; }
        .item-points { font-weight: bold; margin-left: 10px; color: #8faecf; }
        .footer-summary { margin-top: 30px; text-align: right; position: relative; }
        .total-label { font-size: 11px; color: #ccc; letter-spacing: 2px; text-transform: uppercase; }
        .total-points { font-size: 48px; color: #8faecf; line-height: 1; font-weight: 300; margin-top: 5px; }
        .total-unit { font-size: 16px; margin-left: 5px; }
        .deco-star { position: absolute; color: #fad0c4; font-size: 20px; opacity: 0.6; }
    </style>
</head>
<body>

    <div class="controls">
        <h3>☁️ 箱庭入夢・集點櫃台</h3>
        <input type="text" id="csvUrlInput" placeholder="https://docs.google.com/spreadsheets/d/e/2PACX-1vSRN8TqorraKVjJ3FGYpndM6aUQFQcor-4TzrIG_smGY42hTgteuLL_lvGNMKj1wcYPQ70WMz-iWMpA/pub?output=csv" style="width:90%; font-size:11px;">
        <br><br>
        <input type="text" id="userIdInput" placeholder="請輸入噗浪 ID (例如: namida127_draw)">
        <br>
        <button class="btn-gen" onclick="fetchAndGenerate()">生成手帳</button>
        <button class="btn-dl" onclick="downloadImage()">下載圖片</button>
        <p id="statusMsg" style="font-size:12px; color:#aaa; margin-top:10px;">請先貼上 CSV 連結</p>
    </div>

    <div id="receipt-canvas">
        <div class="gradient-orb orb-1"></div>
        <div class="gradient-orb orb-2"></div>
        <div class="deco-star" style="top:40px; left:120px;">✦</div>
        <div class="deco-star" style="bottom:80px; left:60px;">✦</div>
        <div class="deco-star" style="top:150px; right:40px;">*</div>

        <div class="layout-container">
            <div class="sidebar">
                <div class="vertical-text">深秋入冬</div>
                <div class="logo-text">Hakoniwa Irume</div>
                <div class="vertical-text" style="font-size: 14px; margin-top: auto;">集點手帳</div>
            </div>

            <div class="main-content">
                <div class="header-info">
                    <div class="user-id">PLURK ID</div>
                    <div class="user-name">@<span id="displayUser">---</span></div>
                </div>

                <ul class="record-list" id="recordList">
                    <li style="text-align:center; color:#ddd; margin-top:50px;">等待查詢中...</li>
                </ul>

                <div class="footer-summary">
                    <div class="total-label">Current Points</div>
                    <div class="total-points"><span id="totalPoints">0</span><span class="total-unit">pts</span></div>
                    <div style="font-size: 10px; color: #ddd; margin-top: 10px;">
                        具體兌換規則請至置頂噗 (回饋福利)
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 全域變數儲存資料
        let globalData = [];

        async function fetchAndGenerate() {
            const csvUrl = document.getElementById('csvUrlInput').value.trim();
            const userId = document.getElementById('userIdInput').value.trim();

            if (!csvUrl) { alert("請先貼上 CSV 連結！"); return; }
            if (!userId) { alert("請輸入 ID！"); return; }

            updateStatus("正在讀取箱庭紀錄...");

            // 使用 PapaParse 讀取 CSV
            Papa.parse(csvUrl, {
                download: true,
                header: true, // 自動識別標題列 (ID, 總消費金額, 目前點數...)
                complete: function(results) {
                    globalData = results.data;
                    console.log("資料載入成功", globalData);
                    updateStatus("資料讀取成功！正在生成...");
                    generateReceipt(userId);
                },
                error: function(err) {
                    console.error(err);
                    updateStatus("讀取失敗，請檢查連結權限 (是否已發布為 CSV)");
                    alert("讀取失敗！請確認：\n1. 連結是否為「發布到網路」的 CSV 連結\n2. 連結是否有權限問題");
                }
            });
        }

        function generateReceipt(userId) {
            const listContainer = document.getElementById('recordList');
            listContainer.innerHTML = ''; // 清空列表
            document.getElementById('displayUser').innerText = userId;

            // 1. 在資料中尋找該 ID
            // 欄位名稱對應您的工作表：'ID', '目前點數', '消費歷史'
            const userRow = globalData.find(row => 
                row['ID'] && row['ID'].trim().toLowerCase() === userId.toLowerCase()
            );

            if (!userRow) {
                listContainer.innerHTML = '<li style="text-align:center; color:#ddd; margin-top:50px;">查無此 ID 的紀錄</li>';
                document.getElementById('totalPoints').innerText = "0";
                return;
            }

            // 2. 顯示點數
            // 您的表格欄位是 "目前點數"
            document.getElementById('totalPoints').innerText = userRow['目前點數'] || "0";

            // 3. 解析並顯示歷史紀錄
            // 您的歷史紀錄格式範例："2025-11-27 - 1700 2026-01-08 - 2800"
            // 我們需要把這個長字串切開來
            const historyString = userRow['消費歷史'] || "";
            
            // 簡單的解析邏輯：用空白分割，因為您的格式看起來是 "日期 - 金額 日期 - 金額"
            // 但如果中間有換行符號，我們要先處理
            // 這裡嘗試用正規表達式抓出 "YYYY-MM-DD - 數字" 的模式
            // Regex: (\d{4}-\d{2}-\d{2})\s*-\s*(\d+)
            const regex = /(\d{4}-\d{2}-\d{2})\s*-\s*(\d+)/g;
            let match;
            let records = [];

            while ((match = regex.exec(historyString)) !== null) {
                records.push({
                    date: match[1],
                    amount: match[2]
                });
            }

            // 排序：新的日期在上面
            records.sort((a, b) => b.date.localeCompare(a.date));

            // 渲染到畫面上
            if (records.length === 0) {
                 // 如果沒有正規格式的紀錄，試著直接顯示文字 ( fallback )
                 if(historyString.length > 0) {
                     listContainer.innerHTML = `<li class="record-item"><span class="item-desc">${historyString}</span></li>`;
                 } else {
                     listContainer.innerHTML = '<li style="text-align:center; color:#ddd; margin-top:50px;">尚無詳細消費紀錄</li>';
                 }
            } else {
                records.forEach(rec => {
                    // 格式化日期 2025-11-27 -> 25.11.27
                    let dateObj = new Date(rec.date);
                    let yy = dateObj.getFullYear().toString().substr(-2);
                    let mm = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                    let dd = dateObj.getDate().toString().padStart(2, '0');
                    let dateStr = `${yy}.${mm}.${dd}`;

                    let li = document.createElement('li');
                    li.className = 'record-item';
                    li.innerHTML = `
                        <span class="item-date">${dateStr}</span>
                        <span class="item-desc">消費累積</span>
                        <span class="item-points">+${rec.amount}元</span>
                    `;
                    listContainer.appendChild(li);
                });
            }
            updateStatus("生成完成！");
        }

        function updateStatus(msg) {
            document.getElementById('statusMsg').innerText = msg;
        }

        function downloadImage() {
            const node = document.getElementById('receipt-canvas');
            html2canvas(node, { scale: 2, backgroundColor: null }).then(canvas => {
                let link = document.createElement('a');
                link.download = `箱庭手帳_${document.getElementById('displayUser').innerText}.jpg`;
                link.href = canvas.toDataURL("image/jpeg", 0.9);
                link.click();
            });
        }
    </script>
</body>
</html>
