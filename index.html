<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>箱庭入夢 - 集點手帳</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        /* === 箱庭風格 CSS === */
        body { font-family: 'Noto Serif TC', serif; background-color: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 30px; color: #555; margin: 0; }
        .controls { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 30px; text-align: center; width: 100%; max-width: 400px; border: 1px solid #eef; }
        .controls h3 { margin-top: 0; color: #8faecf; }
        
        /* 下拉選單樣式優化 */
        select { padding: 12px; border: 1px solid #a1c4fd; border-radius: 8px; width: 80%; text-align: center; font-family: inherit; margin-bottom: 15px; font-size: 16px; color: #555; background-color: #f9fbff; cursor: pointer; }
        select:focus { outline: none; box-shadow: 0 0 0 3px rgba(161, 196, 253, 0.3); }

        button { padding: 10px 25px; border: none; border-radius: 30px; cursor: pointer; font-family: inherit; transition: 0.3s; font-weight: bold; letter-spacing: 1px; }
        .btn-dl { background: #fad0c4; color: white; margin-top: 10px; width: 80%; }
        button:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        #receipt-canvas { width: 500px; min-height: 700px; background: #fff; position: relative; box-shadow: 0 15px 40px rgba(0,0,0,0.1); overflow: hidden; display: flex; background-image: repeating-linear-gradient(45deg, #fffcfc 25%, transparent 25%, transparent 75%, #fffcfc 75%, #fffcfc), repeating-linear-gradient(45deg, #fffcfc 25%, #fff 25%, #fff 75%, #fffcfc 75%, #fffcfc); background-position: 0 0, 10px 10px; background-size: 20px 20px; }
        .gradient-orb { position: absolute; border-radius: 50%; filter: blur(60px); z-index: 0; }
        .orb-1 { top: -50px; right: -50px; width: 300px; height: 300px; background: rgba(161, 196, 253, 0.4); }
        .orb-2 { bottom: -50px; left: -50px; width: 350px; height: 350px; background: rgba(250, 208, 196, 0.4); }
        .layout-container { position: relative; z-index: 2; width: 100%; display: flex; padding: 40px; }
        .sidebar { width: 70px; border-right: 1px solid rgba(0,0,0,0.05); margin-right: 30px; display: flex; flex-direction: column; justify-content: space-between; align-items: center; padding-top: 20px; padding-bottom: 20px; }
        .vertical-text { writing-mode: vertical-rl; text-orientation: mixed; letter-spacing: 0.8em; color: #8faecf; font-size: 24px; font-weight: 300; }
        .logo-text { writing-mode: vertical-rl; font-size: 10px; letter-spacing: 2px; color: #ccc; text-transform: uppercase; }
        .main-content { flex: 1; display: flex; flex-direction: column; }
        .header-info { text-align: right; margin-bottom: 30px; border-bottom: 2px solid #fad0c4; padding-bottom: 15px; }
        .user-id { font-size: 14px; color: #aaa; letter-spacing: 1px; }
        .user-name { font-size: 22px; color: #555; margin-top: 5px; font-weight: 500; }
        .record-list { list-style: none; padding: 0; margin: 0; flex-grow: 1; }
        .record-item { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 12px; font-size: 13px; border-bottom: 1px dashed #eee; padding-bottom: 8px; }
        .item-date { font-family: 'Courier New', monospace; color: #bbb; margin-right: 10px; font-size: 12px; }
        .item-desc { color: #666; flex: 1; }
        .item-points { font-weight: bold; margin-left: 10px; color: #8faecf; }
        .footer-summary { margin-top: 30px; text-align: right; position: relative; }
        .total-label { font-size: 11px; color: #ccc; letter-spacing: 2px; text-transform: uppercase; }
        .total-points { font-size: 48px; color: #8faecf; line-height: 1; font-weight: 300; margin-top: 5px; }
        .total-unit { font-size: 16px; margin-left: 5px; }
        .deco-star { position: absolute; color: #fad0c4; font-size: 20px; opacity: 0.6; }
    </style>
</head>
<body>

    <div class="controls">
        <h3>☁️ 箱庭入夢・集點櫃台</h3>
        <p style="font-size:12px; color:#aaa; margin-bottom:10px;">請選擇客人 ID (資料已自動同步)</p>
        
        <select id="userSelect" onchange="generateReceipt()">
            <option value="">正在讀取資料...</option>
        </select>
        
        <br>
        <button class="btn-dl" onclick="downloadImage()">⬇️ 下載圖片</button>
        <p id="statusMsg" style="font-size:12px; color:#aaa; margin-top:10px;">資料載入中...</p>
    </div>

    <div id="receipt-canvas">
        <div class="gradient-orb orb-1"></div>
        <div class="gradient-orb orb-2"></div>
        <div class="deco-star" style="top:40px; left:120px;">✦</div>
        <div class="deco-star" style="bottom:80px; left:60px;">✦</div>
        <div class="deco-star" style="top:150px; right:40px;">*</div>

        <div class="layout-container">
            <div class="sidebar">
                <div class="vertical-text">深秋入冬</div>
                <div class="logo-text">Hakoniwa Irume</div>
                <div class="vertical-text" style="font-size: 14px; margin-top: auto;">集點手帳</div>
            </div>

            <div class="main-content">
                <div class="header-info">
                    <div class="user-id">PLURK ID</div>
                    <div class="user-name">@<span id="displayUser">---</span></div>
                </div>

                <ul class="record-list" id="recordList">
                    <li style="text-align:center; color:#ddd; margin-top:50px;">請選擇一位客人</li>
                </ul>

                <div class="footer-summary">
                    <div class="total-label">Current Points</div>
                    <div class="total-points"><span id="totalPoints">0</span><span class="total-unit">pts</span></div>
                    <div style="font-size: 10px; color: #ddd; margin-top: 10px;">
                        具體兌換規則請至置頂噗 (回饋福利)
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // 【重要】請把你的「集點卡」工作表 CSV 連結貼在下面引號內！
        //  (連結結尾應該是 output=csv)
        // ==========================================
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSRN8TqorraKVjJ3FGYpndM6aUQFQcor-4TzrIG_smGY42hTgteuLL_lvGNMKj1wcYPQ70WMz-iWMpA/pub?output=csv'; 
        // ==========================================

        let globalData = [];

        // 頁面載入時自動執行
        window.onload = function() {
            if(CSV_URL.includes('請在這裡貼上')) {
                alert("請記得編輯 HTML 檔案，把 CSV 連結貼上去喔！");
                updateStatus("尚未設定 CSV 連結");
                return;
            }
            fetchAndInit();
        };

        function fetchAndInit() {
            updateStatus("正在從雲端讀取名單...");
            Papa.parse(CSV_URL, {
                download: true,
                header: true,
                complete: function(results) {
                    globalData = results.data;
                    console.log("資料載入成功", globalData);
                    initDropdown();
                    updateStatus("準備就緒！請選擇客人");
                },
                error: function(err) {
                    console.error(err);
                    updateStatus("讀取失敗，請檢查連結");
                    alert("讀取 CSV 失敗，請確認連結權限！");
                }
            });
        }

        // 初始化下拉選單 (這就是不用 B2 也能做到的魔法)
        function initDropdown() {
            const select = document.getElementById('userSelect');
            select.innerHTML = '<option value="">-- 請選擇 ID --</option>';

            // 從資料中抓出所有 ID，並建立選項
            globalData.forEach(row => {
                // 假設欄位名稱是 'ID' (根據你的 Sheet)
                // 如果 ID 不是空的，就加進選單
                if (row['ID'] && row['ID'].trim() !== '') {
                    let option = document.createElement('option');
                    option.value = row['ID']; // 真正的值
                    option.text = row['ID'];  // 顯示的文字
                    select.appendChild(option);
                }
            });
        }

        // 當選單改變時，自動生成收據
        function generateReceipt() {
            const userId = document.getElementById('userSelect').value;
            const listContainer = document.getElementById('recordList');
            
            if (!userId) {
                document.getElementById('displayUser').innerText = "---";
                document.getElementById('totalPoints').innerText = "0";
                listContainer.innerHTML = '<li style="text-align:center; color:#ddd; margin-top:50px;">請選擇一位客人</li>';
                return;
            }

            document.getElementById('displayUser').innerText = userId;
            listContainer.innerHTML = ''; // 清空列表

            // 尋找該 ID 的資料
            const userRow = globalData.find(row => row['ID'] == userId);

            if (userRow) {
                // 1. 顯示點數
                document.getElementById('totalPoints').innerText = userRow['目前點數'] || "0";

                // 2. 解析歷史紀錄
                const historyString = userRow['消費歷史'] || "";
                // Regex 抓取 "YYYY-MM-DD - 數字"
                const regex = /(\d{4}-\d{2}-\d{2})\s*-\s*(\d+)/g;
                let match;
                let records = [];

                while ((match = regex.exec(historyString)) !== null) {
                    records.push({ date: match[1], amount: match[2] });
                }

                records.sort((a, b) => b.date.localeCompare(a.date));

                if (records.length === 0) {
                     // 如果沒有正規格式，顯示原始文字
                     if(historyString.length > 0) {
                         listContainer.innerHTML = `<li class="record-item"><span class="item-desc">${historyString}</span></li>`;
                     } else {
                         listContainer.innerHTML = '<li style="text-align:center; color:#ddd; margin-top:50px;">尚無詳細消費紀錄</li>';
                     }
                } else {
                    records.forEach(rec => {
                        let dateObj = new Date(rec.date);
                        let yy = dateObj.getFullYear().toString().substr(-2);
                        let mm = (dateObj.getMonth() + 1).toString().padStart(2, '0');
                        let dd = dateObj.getDate().toString().padStart(2, '0');
                        let dateStr = `${yy}.${mm}.${dd}`;

                        let li = document.createElement('li');
                        li.className = 'record-item';
                        li.innerHTML = `
                            <span class="item-date">${dateStr}</span>
                            <span class="item-desc">消費累積</span>
                            <span class="item-points">+${rec.amount}元</span>
                        `;
                        listContainer.appendChild(li);
                    });
                }
            }
        }

        function updateStatus(msg) {
            document.getElementById('statusMsg').innerText = msg;
        }

        function downloadImage() {
            const node = document.getElementById('receipt-canvas');
            // 先隱藏邊框陰影以免截圖有黑邊 (Optional)
            html2canvas(node, { scale: 2, backgroundColor: null }).then(canvas => {
                let link = document.createElement('a');
                link.download = `箱庭手帳_${document.getElementById('displayUser').innerText}.jpg`;
                link.href = canvas.toDataURL("image/jpeg", 0.9);
                link.click();
            });
        }
    </script>
</body>
</html>
